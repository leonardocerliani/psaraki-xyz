{
  "hash": "a0865ee37971a9969a96ac7397aa5bdf",
  "result": {
    "markdown": "---\ntitle: \"Framingham CHD logistic regression\"\nsubtitle: \"Modelling the 10-years risk of coronary heart disease\"\nauthor: \"Leonardo Cerliani\"\ndate: \"7/23/2023\"\noutput:\n  html_document:\n    self_contained: true\n    toc: true\n    toc_depth: 3\n    toc_float: true\n    code_folding: hide\n    theme: cerulean \nimage: \"app_logistic.jpg\"\n---\n\n\n\n# Introduction\nThe [Framingham dataset](https://datacatalog.med.nyu.edu/dataset/10046) (available also on [kaggle](https://www.kaggle.com/datasets/aasheesh200/framingham-heart-study-dataset)) is an ongoing study which has been running since 1948. It aims to identify demographic, lifestyle and medical factors which are associated with the 10-year risk of developing heart disease.\n\nHere we use logistic regression to model the 10-year risk of coronary heart disease (CHD). The dataset consists of:\n\n- 4238 individuals, 15% of which with assessed risk of CHD\n\n- 43% males, 57% females between 32 and 70 yrs (median age = 49)\n\n- 15 recorded variables, including education, smoking habits, blood pressure measurements and anomalies, blood sample indices (e.g. glucose), medicament assumptions.\n\n\n# Main takeaways\n\n[Presentation slides](https://github.com/leonardocerliani/TC_projects/blob/main/CHD_Logistic_regression/presentation_framingham.pdf)\n\n- **The final model correctly predicts risk of CHD in 10 years in 83% of the people who are actually at risk (sensitivity)** when the threshold for binary classification is set at 0.1\n\n- The choice of this threshold (0.1) leads to many false positives, however given the potential life-threatening implications of false negatives - and the relatively simple continous monitoring of the patients with positive prediction - the choice obviously falls on maximising the sensitivity.\n\n- **The model is simple, contaning only easily retrievable variables**: sex, age, systolic blood pressure, glucose and smoking habits\n\n- Assumption of blood pressure medicaments does _not_ appear to decrease the odds of CHD risk\n\n- The amount of explained variance is moderate (17%). Other unexplored variables such as alcohol consumption, stress and wealth (among others) might improve model fit and performance.\n\n\n# Column description\n\n- **Sex**: male or female(Nominal)\n- **Age**: Age of the patient;(Continuous - Although the recorded ages have been truncated to whole numbers, the concept of age is continuous)\n- **Current Smoker**: whether or not the patient is a current smoker (Nominal)\n- **Cigs Per Day**: the number of cigarettes that the person smoked on average in one day.(can be considered continuous as one can have any number of cigarettes, even half a cigarette.)\n\nMedical( history)\n\n- **BP Meds**: whether or not the patient was on blood pressure medication (Nominal)\n- **Prevalent Stroke**: whether or not the patient had previously had a stroke (Nominal)\n- **Prevalent Hyp**: whether or not the patient was hypertensive (Nominal)\n- **Diabetes**: whether or not the patient had diabetes (Nominal)\n- **Tot Chol**: total cholesterol level (Continuous)\n- **Sys BP**: systolic blood pressure (Continuous)\n- **Dia BP**: diastolic blood pressure (Continuous)\n- **BMI**: Body Mass Index (Continuous)\n- **Heart Rate**: heart rate (Continuous - In medical research, variables such as heart rate though in fact discrete, yet are considered continuous because of large number of possible values.)\n- **Glucose**: glucose level (Continuous)\n\nPredict variable (desired target)\n- **10 year risk of coronary heart disease CHD** (binary: “1”, means “Yes”, “0” means “No”)\n\n\n_Abbreviations:_\n- **EDA** : Exploratory Data Analysis\n- **EV** : Explanatory Variable (i.e. predictor)\n\n# Load libraries and data\n\n::: {.cell}\n\n```{.r .fold-show .cell-code}\nlibrary(tidyverse)\nlibrary(janitor)\nlibrary(emmeans)\nlibrary(dlookr)\nlibrary(flextable)\nlibrary(jtools)\nlibrary(GGally)\nlibrary(vcd)\nlibrary(ggstatsplot)\nlibrary(gridExtra)\nlibrary(caret)\nlibrary(jtools)\nlibrary(kableExtra)\nlibrary(plotly)\nlibrary(highcharter)\nlibrary(pROC)\n   \n\nselect <- dplyr::select\n\ndf <- read_csv(\"Graded_task_Heart_disease_data.csv\") %>% \n tibble %>% \n janitor::clean_names()\n\n# change appropriate variables to factor\ndf <- df %>% mutate_at(\n c(\"male\",\"education\",\"current_smoker\",\"bp_meds\",\n   \"prevalent_stroke\",\"prevalent_hyp\",\n   \"diabetes\",\"ten_year_chd\"), factor\n)\n\n# df %>% glimpse()\n\n# dlookr::diagnose(df) %>% flextable\n```\n:::\n\n\n\n\n\n# Split train/test\n\nTo estimate the perfomance of the model with out-of-sample data, we split the whole dataset in a train (60% - 2543 data points) and test (40% - 1695 data points) set.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(124)\nN = nrow(df)\nsplit_index <- sample(c(\"train\",\"test\"), N, replace = T, prob = c(0.6,0.4))\n\ntrain <- df[which(split_index == \"train\"),]  # train set\ntest <- df[which(split_index == \"test\"),]  # test set\n```\n:::\n\n\n\n\n# Outliers check\nWe will carry out the check for outliers - and subsequently evaluate potential imputation for NA - only on the train data, and blindly apply this to the test. In a real world situation, the test set can grow continously, therefore we need to take decisions only on the train data.\n\nThe evaluation for potential NA imputation will be carried out later, just before modelling. The reason for this is that carrying out NA imputation first would bias the EDA.\n\n\n**Observations**\nAll the numerical values are in the norm, except for blood pressure. Specifically, the systolic blood pressure `sys_bp` is way too high, with about 4% of the participants having a bp > 180 (requiring immediate medical care).\n\nHowever, in published papers on the Framinghton studies these values are accepted as plausible. We will therefore only exclude values above 250 mmHg.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# train %>% select_if(is.numeric) %>% summary()\n\n# boxplot(glucose ~ diabetes, data = train, main = \"glucose ~ diabetes\")\n\nboxplot(sys_bp ~ bp_meds, data = train, main = \"systolic blood pressure ~ bp_meds\")\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\nboxplot(sys_bp ~ prevalent_hyp, data = train, main = \"systolic blood pressure ~ hypertension\")\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# percent of people with sys_bp > 180\npct_high_sys_bp <- round((train$sys_bp > 180) %>% sum() / nrow(train) * 100,2)\n\n# xtabs(~ prevalent_hyp + bp_meds, data = train)\n\ntrain <- train %>% filter(sys_bp <= 250)\ntest <- test %>% filter(sys_bp <= 250)\n```\n:::\n\n\n\n\n# EDA of numerical variables\n\nInitially, we carry out t-tests to discover which EVs exhibit (corrected) significant differences between people with and without risk of CHD. \n\nThen we will also examine the potential correlations between variables. If the latter are substantial, we will evaluate the possibility of discarding some EVs due to collinearity.\n\n\n## Two-independent-samples t-tests {.tabset}\n\n(an excercise in [fitting many models using `purrr::map`](https://www.youtube.com/watch?v=rz3_FDVt9eg))\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyr)\n\nttests <- train %>%\n   # select(\"ten_year_chd\", \"age\", \"glucose\") %>%\n   \n   select(-c(\"education\",\"male\",\"current_smoker\",\"bp_meds\",\n           \"prevalent_stroke\",\"prevalent_hyp\", \"diabetes\")) %>% \n   na.omit() %>%\n   \n   # pivot longer to prepare the nesting\n   pivot_longer(\n      cols = -ten_year_chd, \n      names_to = \"variable\", values_to = \"value\"\n   ) %>% \n   group_by(variable) %>% \n   group_nest() %>%\n   \n   # fit a model to each nested df\n   mutate(\n    ttmod = map(data, ~ lm(value ~ ten_year_chd, data = .x))\n   ) %>% \n\n   # get the stats\n   mutate(\n      tidy = map(ttmod, broom::tidy)\n   ) %>% \n   unnest(tidy) %>% \n   filter(term == \"ten_year_chd1\") %>% \n   \n   # correct for multiple comparisons\n   mutate(adj_pval = p.adjust(p.value, method = \"fdr\")) %>% \n   # filter(adj_pval <= 0.01) %>% \n   relocate(adj_pval, .after=variable) %>% \n   arrange(adj_pval)\n\n\nttests %>%\n  select(variable, statistic, adj_pval) %>%\n  rename(`t value` = statistic) %>%\n  flextable() %>%\n  set_formatter(adj_pval = function(x) sprintf(\"%.2e\", x))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div class=\"tabwid\"><style>.cl-c8f5178c{}.cl-c8ebe3ce{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c8efd97a{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c8efd984{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c8eff14e{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c8eff158{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c8eff162{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c8eff16c{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c8eff16d{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c8eff176{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing='true' class='cl-c8f5178c'><thead><tr style=\"overflow-wrap:break-word;\"><th class=\"cl-c8eff14e\"><p class=\"cl-c8efd97a\"><span class=\"cl-c8ebe3ce\">variable</span></p></th><th class=\"cl-c8eff158\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">t value</span></p></th><th class=\"cl-c8eff158\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">adj_pval</span></p></th></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-c8eff162\"><p class=\"cl-c8efd97a\"><span class=\"cl-c8ebe3ce\">age</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">12.0815563</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">1.01e-31</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-c8eff162\"><p class=\"cl-c8efd97a\"><span class=\"cl-c8ebe3ce\">sys_bp</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">11.9732840</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">1.73e-31</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-c8eff162\"><p class=\"cl-c8efd97a\"><span class=\"cl-c8ebe3ce\">dia_bp</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">8.2215602</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">8.85e-16</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-c8eff162\"><p class=\"cl-c8efd97a\"><span class=\"cl-c8ebe3ce\">glucose</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">6.5653995</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">1.28e-10</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-c8eff162\"><p class=\"cl-c8efd97a\"><span class=\"cl-c8ebe3ce\">bmi</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">5.6308260</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">3.22e-08</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-c8eff162\"><p class=\"cl-c8efd97a\"><span class=\"cl-c8ebe3ce\">tot_chol</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">4.0326391</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">7.59e-05</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-c8eff162\"><p class=\"cl-c8efd97a\"><span class=\"cl-c8ebe3ce\">cigs_per_day</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">2.1141771</span></p></td><td class=\"cl-c8eff16c\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">3.96e-02</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-c8eff16d\"><p class=\"cl-c8efd97a\"><span class=\"cl-c8ebe3ce\">heart_rate</span></p></td><td class=\"cl-c8eff176\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">0.8512159</span></p></td><td class=\"cl-c8eff176\"><p class=\"cl-c8efd984\"><span class=\"cl-c8ebe3ce\">3.95e-01</span></p></td></tr></tbody></table></div>\n\n`````\n:::\n:::\n\n\n<br>\n\n### Age\n\n::: {.cell}\n\n```{.r .cell-code}\nggbetweenstats(\n   data = train,\n   x = ten_year_chd,\n   y = age\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n### Systolic blood pressure\n\n::: {.cell}\n\n```{.r .cell-code}\nggbetweenstats(\n   data = train,\n   x = ten_year_chd,\n   y = sys_bp\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n### Diastolic blood pressure\n\n::: {.cell}\n\n```{.r .cell-code}\n# \nggbetweenstats(\n   data = train,\n   x = ten_year_chd,\n   y = dia_bp\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n### Glucose\n\n::: {.cell}\n\n```{.r .cell-code}\n# \nggbetweenstats(\n   data = train,\n   x = ten_year_chd,\n   y = glucose\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n### BMI\n\n::: {.cell}\n\n```{.r .cell-code}\n# \nggbetweenstats(\n   data = train,\n   x = ten_year_chd,\n   y = bmi\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n### Cholesterol level\n\n::: {.cell}\n\n```{.r .cell-code}\n# \nggbetweenstats(\n   data = train,\n   x = ten_year_chd,\n   y = tot_chol\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n## Correlation matrix\nExploring the correlation matrix of the numerical variables to detect potential collinearity\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain %>% \n # select(-c(\"education\",\"male\",\"current_smoker\",\"bp_meds\",\n #           \"prevalent_stroke\",\"prevalent_hyp\", \"diabetes\")) %>%\n select(ten_year_chd, age, sys_bp, dia_bp, bmi, glucose, tot_chol) %>% \n na.omit() %>% \n # mutate_at(vars(-ten_year_chd), ~ log(. + 1)) %>% \n GGally::ggpairs(\n    aes(color = ten_year_chd),\n    upper = list(continuous = wrap(\"cor\", size = 3)),\n    lower = list(continuous = wrap(\"points\", alpha = 0.7, size = 1)),\n    diag = list(continuous = wrap(\"densityDiag\", alpha = 0.5))\n )\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n\n## Observations - numerical EVs\n\n- `age` appears to be the most discriminant variable for ten year CHD prediction. Other EVs which are significantly different (after correction with FDR) in people with and without CHD risk are `bmi`, `sys_bp`, `dia_bp`, `glucose`, `tot_chol`.\n\n- the systolic `sys_bp` and diastolic `dia_bp` blood pressure are correlated with each other - as expected. Since CHD is especially related to hypertension, we will only use systolic blood pressure\n\n- `bmi` and `age` are also correlated with blood pressure, however they appear to be important variables for CHD and their correlation with blood pressure is mild, so we will keep them\n\n- NB: the number of cigarettes per day (`cigs_per_day`) will be explored as a categorical variable (see below) with levels for tens of cigarettes per day\n\n\n\n# EDA of categorical variables  \n\n::: {.cell}\n\n```{.r .cell-code}\n# train %>% select_if(is.factor) %>% summary\n```\n:::\n\n\nAs before for the numerical variables, we will first assess a dependence between risk of CHD and other categorical variables, and then explore the reciprocal relationships of all categorical variables to assess the presence of collinearity.\n\n## Chi-square tests {.tabset}\n\n### Sex (male)\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggstatsplot)\n\nggbarstats(\n   data = train %>% select(ten_year_chd, male),\n   x = male,\n   y = ten_year_chd,\n   label = \"both\"\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n### Hypertension\n\n::: {.cell}\n\n```{.r .cell-code}\nggbarstats(\n   data = train %>% select(ten_year_chd, prevalent_hyp),\n   x = prevalent_hyp,\n   y = ten_year_chd,\n   label = \"both\"\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n### Cigarettes per day\n\nThe values are too sparse to treat this as a continous variable. We will therefore group the # cigs per day in tens and treat this as a categorical variable.\n\nA first visual exploration shows that there appear to be mild differences in the proportion of people smoking different amount of cigarettes per day.\n\nWhen carrying out a chi-square test of independence, we are warned that the results might be incorrect. This appears to be due to the fact that there are too few observations in the category for 50 and 60 cigarettes per day. When these levels are removed, a significant (p = 0.0066) dependence is shown between risk group and amount of cigarettes per day.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Suppress summarise info\noptions(dplyr.summarise.inform = FALSE)\n\ntrain %>% \n   select(ten_year_chd, cigs_per_day) %>% \n   na.omit() %>% \n   mutate(cigs_factor = round(cigs_per_day/10,0)) %>% \n   group_by(ten_year_chd, cigs_factor) %>% \n   summarise(count = n(), .group = \"drop\") %>% \n   group_by(ten_year_chd) %>%\n   mutate(prop = count / sum(count)) %>% \n   select(ten_year_chd, cigs_factor, prop) %>%\n   ggplot(aes(x = factor(cigs_factor), y = prop, fill = ten_year_chd)) +\n   geom_bar(stat = \"identity\", position = \"dodge\") + \n   labs(x = \"Tens of Cigarettes per Day\", y = \"Proportion in each group\", fill = \"CHD Status\")\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n\n```{.r .cell-code}\ntrain %>% \n   select(ten_year_chd, cigs_per_day) %>% \n   mutate(tens_cigarettes = round(cigs_per_day/10, 0) ) %>% \n   filter(tens_cigarettes < 5) %>% \n   select(-cigs_per_day) %>% \n   na.omit() %>% \n   xtabs(~ ten_year_chd + tens_cigarettes, data = .) %>% \n   chisq.test()  %>% tidy() %>% kable(format = \"html\") %>%\n   add_header_above(c(\"Chi-Square CHD Risk ~ Tens_of_cigarettes\" = 4)) %>%\n   kable_styling()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n<tr><th style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"4\"><div style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \">Chi-Square CHD Risk ~ Tens_of_cigarettes</div></th></tr>\n  <tr>\n   <th style=\"text-align:right;\"> statistic </th>\n   <th style=\"text-align:right;\"> p.value </th>\n   <th style=\"text-align:right;\"> parameter </th>\n   <th style=\"text-align:left;\"> method </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 14.22453 </td>\n   <td style=\"text-align:right;\"> 0.0066119 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> Pearson's Chi-squared test </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n### Current smoker\n\n::: {.cell}\n\n```{.r .cell-code}\nggbarstats(\n   data = train %>% select(ten_year_chd, current_smoker),\n   x = current_smoker,\n   y = ten_year_chd,\n   label = \"both\"\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n\n### Blood pressure medication\n\n::: {.cell}\n\n```{.r .cell-code}\nggbarstats(\n   data = train %>% select(ten_year_chd, bp_meds),\n   x = bp_meds,\n   y = ten_year_chd,\n   label = \"both\"\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n### Education\n\n::: {.cell}\n\n```{.r .cell-code}\nggbarstats(\n   data = train %>% select(ten_year_chd, education),\n   x = education,\n   y = ten_year_chd,\n   label = \"both\"\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n\n\n## Association matrix (categorical)\nGraphically display the association between binary categorical variables, including `ten_year_chd` to assess the presence of correlated predictors\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(vcd)\n\ntrain_cat <- train %>% select_if(is.factor) %>% select(-c(\"ten_year_chd\",\"education\"))\n\npairs(\n   table(train_cat), \n   diag_panel = pairs_diagonal_mosaic(offset_varnames=-2.5),    #move down variable names\n   upper_panel_args = list(shade = TRUE),                       #set shade colors\n   lower_panel_args = list(shade = TRUE)\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n\n\n## Observations - categorical EVs \n\n- The 10 year risk of CHD is more prevalent in males than in females\n- Not surprisingly, hypertension and assumption of blood pressure medications is also associated with risk. We will also examine the latter, although only ~ 3% of the sample takes these medications\n- The number of cigarettes smoked per day (in groups of 10) also increaes the risk of CHD. Interestingly, still, more than 50% of the people who are at risk do not smoke. It would be interesting to have data about the quality of the air of the place where they live, or whether their partner is a smoker.\n- It is also interesting that the relationship between amount of cigarettes per day and risk is not linear: there are more people at risk among those who smoke 20-30 or 40-50 cigs per day. while among those who smoke 10-20 or 30-40 cigs per day the proportion of people with and without risk is almost 50%. This strange behaviour can probably be - at least in part - explained by the fact that smokers tend to underestimate the amount of cigarettes smoked. \n- Instead, the fact of being a current smoker does not appear to be a risk factor\n- There is an interaction between being make, having hypertension and being a current smoker. We will examine whether this interaction can increase the prediction, although the fact of currently smoking _per se_ apparently does not.\n\n\n# Choice of predictors  {.tabset}\n\n**Numerical variables**\nAge (`age`), High blood pressure (`sys_bp`), body-mass index (`bmi`), glucose blood level (`glucose`), cholesterol blood level (`tot_chol`) appear to be involved in predicting the risk of CHD. As noted above, `cigs_per_day` was treated as a categorical variables with levels for o and multiples of 10.\n\n**Categorical variables**\nSex (`male`), hypertension (`prevalent_hyp`), blood pressure medications (`bp_meds`), education (`education`) and number of cigarettes per day (`cigs_per_day`) appear to be involved in predicting the risk of CHD.\n\nThere are widespread associations between numerical and categorical variables. This is _not_ surprising for two reasons:\n\n- some variables are proxy each other (e.g. `sys_bp`, `prevalence_hyp`, `bp_meds`)\n- some variables are linked by known relationships: e.g. with `age`, the `bmi` increases, and both are likely to lead to increased blood pressure `sys_bp`, which in turn can lead to hypertension and relative medicaments\n\nDespite this, we will enter all the selected variables in the model and assess the presence of collinearity using VIF.\n\n\n## age \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gridExtra)\n\nboxplot_tt <- function(response, predictor) {\n   tt <- t.test(train[[response]] ~ train[[predictor]], data =train)\n   \n   res <- paste0(\"t = \", round(tt$statistic,2), \" p = \", round(tt$p.value,4))\n   \n   p <- train %>% na.omit() %>% \n      ggplot(aes(x = .data[[predictor]], y = .data[[response]])) +\n      geom_boxplot() +\n      labs(title = paste0(predictor,\" vs \", response),\n           subtitle = res)\n   \n   return(p)\n   \n}\n\np1 <- boxplot_tt(\"age\", \"male\")\np2 <- boxplot_tt(\"age\", \"prevalent_hyp\")\np3 <- boxplot_tt(\"age\", \"bp_meds\")\n\ngrid.arrange(p1, p2, p3, nrow = 1)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n## bmi\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- boxplot_tt(\"bmi\", \"male\")\np2 <- boxplot_tt(\"bmi\", \"prevalent_hyp\")\np3 <- boxplot_tt(\"bmi\", \"bp_meds\")\n\ngrid.arrange(p1, p2, p3, nrow = 1)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n## hypertension (sys_bp)\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- boxplot_tt(\"sys_bp\", \"male\")\np2 <- boxplot_tt(\"sys_bp\", \"prevalent_hyp\")\np3 <- boxplot_tt(\"sys_bp\", \"bp_meds\")\n\ngrid.arrange(p1, p2, p3, nrow = 1)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\n## glucose level\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- boxplot_tt(\"glucose\", \"male\")\np2 <- boxplot_tt(\"glucose\", \"prevalent_hyp\")\np3 <- boxplot_tt(\"glucose\", \"bp_meds\")\n\ngrid.arrange(p1, p2, p3, nrow = 1)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n## cholesterol level\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- boxplot_tt(\"tot_chol\", \"male\")\np2 <- boxplot_tt(\"tot_chol\", \"prevalent_hyp\")\np3 <- boxplot_tt(\"tot_chol\", \"bp_meds\")\n\ngrid.arrange(p1, p2, p3, nrow = 1)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n\n\n# NA Assessment  {.tabset}\n\nAs a last step before fitting the models, we need to take care of NAs in these 6 variables. \nAs mentioned in the beginning, we do this here in order not to bias the EDA.\n\nIn case of imputation, we will apply the same procedure blindly to the test set.\n\n`bmi` is significantly different for males and females. There are only 12 values missing. We will impute the NAs with the median of each gender in either risk or no-risk group.\n\n`glucose` and `tot_chol` are significantly different especially in people with and without hypertension. We will impute the NAs with the median of each gender in either risk or no-risk group.\n\n`bp_meds` is a very important variable, and not easy to impute, so we don't want to run risks here. We see from the table below that the people where blood pressure (bp) medication was not recorded have (median) bp values compatible with people who have either high or low blood pressure AND do not take medications. This could justify the imputation. At the same time, this is a very important variable, associated with drug use. We don't want to run this risk. We will therefore discard people where it is not known whether they take medications.\n\n`cigs_per_day` is a variable that can hardly be imputed correctly, therefore we will remove the data points with NA in this variable (less than 1%)\n\n\n## bmi\n\n::: {.cell}\n\n```{.r .cell-code}\n# bmi ~ male\nggbetweenstats(\n   data = train,\n   x = male,\n   y = bmi\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\n## glucose\n\n::: {.cell}\n\n```{.r .cell-code}\n# glucose ~ hypertension\nggbetweenstats(\n   data = train,\n   x = prevalent_hyp,\n   y = glucose\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\n## cholesterol\n\n::: {.cell}\n\n```{.r .cell-code}\n# cholesterol ~ hypertension\nggbetweenstats(\n   data = train,\n   x = prevalent_hyp,\n   y = tot_chol\n)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n## bp_meds\n\n::: {.cell}\n\n```{.r .cell-code}\n# bp_meds ~ prevalent_hyp\ndf %>% \n  select(sys_bp, prevalent_hyp, bp_meds) %>%\n  group_by(bp_meds, prevalent_hyp) %>% \n  summarise(\n    median_sys_bp = median(sys_bp),\n    count_prevalent_hyp = n()\n  ) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 5 × 4\n# Groups:   bp_meds [3]\n  bp_meds prevalent_hyp median_sys_bp count_prevalent_hyp\n  <fct>   <fct>                 <dbl>               <int>\n1 0       0                      122                 2891\n2 0       1                      150.                1170\n3 1       1                      165                  124\n4 <NA>    0                      121                   31\n5 <NA>    1                      154.                  22\n```\n:::\n:::\n\n\nNA imputation on train _and_ test set\n\n::: {.cell}\n\n```{.r .cell-code}\n# ------------------------- train --------------------------------------------\ntrain <- train %>%\n   # impute the bmi as the median of males/females\n   group_by(ten_year_chd, male) %>%\n   mutate(bmi = ifelse(is.na(bmi), median(bmi, na.rm = T),bmi)) %>%\n   ungroup() %>%\n   \n   # impute glucose and cholesterol level as the median of prevalent_hyp\n   group_by(ten_year_chd, prevalent_hyp) %>%\n   mutate(glucose = ifelse(is.na(glucose), median(glucose, na.rm=T), glucose)) %>%\n   mutate(tot_chol = ifelse(is.na(tot_chol), median(tot_chol, na.rm=T), tot_chol)) %>%\n   ungroup() %>% \n   \n   # remove people where bp_meds is not unknown\n   filter(!is.na(bp_meds)) %>% \n   \n   # remove people with no information about education level\n   filter(!is.na(education)) %>% \n   \n   # # remove the mean from numerical variables\n   # mutate_if(is.numeric, ~ . - mean(., na.rm = TRUE)) %>% \n   \n   # remove residual NAs\n   na.omit()\n   \n   \n   \n\ntrain %>% \n   select(\n      ten_year_chd, age, sys_bp, bmi, glucose, tot_chol, \n      male, prevalent_hyp, bp_meds, education\n   ) %>%\n   diagnose %>%\n   flextable\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div class=\"tabwid\"><style>.cl-ed668038{}.cl-ed5d09fe{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-ed60fbe0{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-ed60fbea{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-ed611300{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed611301{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed61130a{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed61130b{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed611314{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed611315{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing='true' class='cl-ed668038'><thead><tr style=\"overflow-wrap:break-word;\"><th class=\"cl-ed611300\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">variables</span></p></th><th class=\"cl-ed611300\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">types</span></p></th><th class=\"cl-ed611301\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">missing_count</span></p></th><th class=\"cl-ed611301\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">missing_percent</span></p></th><th class=\"cl-ed611301\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">unique_count</span></p></th><th class=\"cl-ed611301\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">unique_rate</span></p></th></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">ten_year_chd</span></p></td><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">factor</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">2</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.0008093889</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">age</span></p></td><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">numeric</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">39</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.0157830838</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">sys_bp</span></p></td><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">numeric</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">213</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.0861999191</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">bmi</span></p></td><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">numeric</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">1,099</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.4447592068</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">glucose</span></p></td><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">numeric</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">121</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.0489680291</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">tot_chol</span></p></td><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">numeric</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">227</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.0918656414</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">male</span></p></td><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">factor</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">2</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.0008093889</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">prevalent_hyp</span></p></td><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">factor</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">2</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.0008093889</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">bp_meds</span></p></td><td class=\"cl-ed61130a\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">factor</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">2</span></p></td><td class=\"cl-ed61130b\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.0008093889</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed611314\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">education</span></p></td><td class=\"cl-ed611314\"><p class=\"cl-ed60fbe0\"><span class=\"cl-ed5d09fe\">factor</span></p></td><td class=\"cl-ed611315\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed611315\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0</span></p></td><td class=\"cl-ed611315\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">4</span></p></td><td class=\"cl-ed611315\"><p class=\"cl-ed60fbea\"><span class=\"cl-ed5d09fe\">0.0016187778</span></p></td></tr></tbody></table></div>\n\n`````\n:::\n\n```{.r .cell-code}\n# ------------------------- test --------------------------------------------\ntest <- test %>%\n   # impute the bmi as the median of males/females\n   group_by(ten_year_chd, male) %>%\n   mutate(bmi = ifelse(is.na(bmi), median(bmi, na.rm = T),bmi)) %>%\n   ungroup() %>%\n   \n   # impute glucose and cholesterol level as the median of prevalent_hyp\n   group_by(ten_year_chd, prevalent_hyp) %>%\n   mutate(glucose = ifelse(is.na(glucose), median(glucose, na.rm=T), glucose)) %>%\n   mutate(tot_chol = ifelse(is.na(tot_chol), median(tot_chol, na.rm=T), tot_chol)) %>%\n   ungroup() %>% \n   \n   # remove people where bp_meds is not unknown\n   filter(!is.na(bp_meds)) %>% \n   \n   # remove people with no information about education level\n   filter(!is.na(education)) %>% \n   \n   # # remove the mean from numerical variables\n   # mutate_if(is.numeric, ~ . - mean(., na.rm = TRUE)) %>% \n   \n   # remove residual NAs\n   na.omit()\n\n\n\n\ntest %>% \n   select(\n      ten_year_chd, age, sys_bp, bmi, glucose, tot_chol, \n      male, prevalent_hyp, bp_meds, education\n   ) %>%\n   diagnose %>%\n   flextable\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div class=\"tabwid\"><style>.cl-ed86c6ea{}.cl-ed7d7e64{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-ed81520a{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-ed815214{margin:0;text-align:right;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-ed816a06{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed816a10{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 2pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed816a1a{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed816a1b{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed816a1c{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-ed816a24{width:0.75in;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing='true' class='cl-ed86c6ea'><thead><tr style=\"overflow-wrap:break-word;\"><th class=\"cl-ed816a06\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">variables</span></p></th><th class=\"cl-ed816a06\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">types</span></p></th><th class=\"cl-ed816a10\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">missing_count</span></p></th><th class=\"cl-ed816a10\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">missing_percent</span></p></th><th class=\"cl-ed816a10\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">unique_count</span></p></th><th class=\"cl-ed816a10\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">unique_rate</span></p></th></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">ten_year_chd</span></p></td><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">factor</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">2</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.001265823</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">age</span></p></td><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">numeric</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">37</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.023417722</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">sys_bp</span></p></td><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">numeric</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">201</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.127215190</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">bmi</span></p></td><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">numeric</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">859</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.543670886</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">glucose</span></p></td><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">numeric</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">102</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.064556962</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">tot_chol</span></p></td><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">numeric</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">213</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.134810127</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">male</span></p></td><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">factor</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">2</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.001265823</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">prevalent_hyp</span></p></td><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">factor</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">2</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.001265823</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">bp_meds</span></p></td><td class=\"cl-ed816a1a\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">factor</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">2</span></p></td><td class=\"cl-ed816a1b\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.001265823</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-ed816a1c\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">education</span></p></td><td class=\"cl-ed816a1c\"><p class=\"cl-ed81520a\"><span class=\"cl-ed7d7e64\">factor</span></p></td><td class=\"cl-ed816a24\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a24\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0</span></p></td><td class=\"cl-ed816a24\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">4</span></p></td><td class=\"cl-ed816a24\"><p class=\"cl-ed815214\"><span class=\"cl-ed7d7e64\">0.002531646</span></p></td></tr></tbody></table></div>\n\n`````\n:::\n:::\n\n\n\n\n\n\n# Analytic strategy\n\n**It appears that there are two interesting questions:**\n\n1. How well is the risk predicted by generic factors alone? (such as sex, age, and blood pressure)\n\n2. How much can we increase the prediction if we include other variables more related to hypertension, such as diagnosed hypertension or assumption of blood pressure medications? \n\nSince we allowed some correlated variables to enter the model, we will pay close attention to the VIF (variance inflation factor).\n\nAfter the \"best\" model is detemined by manual stepwise regression, we will compare the former to an automatic stepwise regression carried out using the AIC criterion alone.\n\n\n\n\n\n\n\n\n\n# Logistic regression\n\n\n## Procedure for stepwise modelling\n\nWe start by fitting the **\"maximal\" model**, which includes all the provided EVs, to have a baseline estimate for the AUC of this model and of the impact of the correlation between variables we previously detected with EDA - for the latter, we will check the VIF.\n\nThen we fit the **full model**, which includes all the variables we previously selected based on the EDA. This will show how well the hints gathered in the EDA are actually reflected in the significance of the coefficients. Specifically, compared to the \"maximal\" model.\n\nWe will then proceed to eliminate EVs based on whether the coefficients are not sigificant or have a very small effect (in terms of odds ratio). At each step we evaluate the AIC and AUC to detect whether reducing the EVs led to an increase or decrease of the performance.\n\nFinally we will examine the confusion matrix and adjust the threshold for binary prediction in order to have maximum Sensitivity (more on this later).\n\n\n## Format of the summary tables\n\nThe coefficients are reported in two forms (at the expense of verbosity):\n\n- original, non-standardized and non-exponentiated (using `summary()`): to allow calculation of the odds ratio (via `exp()`) of 10 year CHD given the actual values of the EVs for a specific person.\n\n- standardized and exponentiated (using `jtools::summ()`): to allow comparing the magnitude of the coefficients, to have the confidence intervals and to calculate the VIF.\n\n\n\n\n## Results\n\nThe AIC was similar across all examined models (between 1887 and 1890), therefore this metric had a small weight in the choice of the final model. Similarly, all the models explained at most 17% of the total variance in the data, which is not a substantial amount.\n\nThe VIF was not critical, even in the maximal model, therefore the impact of correlated predictors was minimal or negligible.\n\nThe **maximal model** highlighted the contribution of gender, age, systolic blood pressure, and to a lesser extent the prevalence of hypertension and education. Importantly, the p values for some of these variables was higher than in simpler models, most likely due to collinearity with other variables. The AUC of this model was 0.703.\n\nOur **full model** highlighted the same variables. In addition reducing the number of EVs increased the significance of most of the selected EVs (especially age and systolic blood pressure). The AUC of this model was 0.705.\n\nWe then removed EVs with small or no effect from the full model, specifically blood pressure medications, bmi, cholesterol and education. This led to an AUC of 0.711, and all variables significant.\n\nFurther removing the EVs specifying whether the patient had hypertension led to a simpler model and did not substantially change the AUC (0.713).\n\n**Remarkably, this model contained only gender, age, systolic blood pressure and glucose blood level, in addition to number of cigarettes smoked per day. That is, two common demographic variables, and two physiologic measurements which can be easily retrieved with blood pressure measurement and a simple blood exam**\n\nThe increase in odds to develop a CHD in 10 years were as follows for each EV:\n\n- sex: males have $exp(0.449) \\approx 57\\%$ greater odds of CHD risk than females\n- cigarettes per day : $exp(0.1766) \\approx 19\\%$ greater odds for any additional 10 cigarettes smoked every day\n- age : the odds of CHD increase $exp(0.0658) \\approx 6.8\\%$ every year\n- systolic blood pressure : $exp(0.0186) \\approx 1.8\\%$ greater odds for each mmHg\n- glucose : $exp(0.0075) \\approx 0.7\\%$ greater odds for each mg\n\nThe intercept can be interpreted as the probability of a female being at risk _when all predictors are set to 0_. In our case we have predictors for age, glucose and blood pressure, which are obviously not zero, therefore this interpretation of the intercept is not really helpful in our case. For the sake of calculation: $p = \\frac{e^{\\beta_0}}{1 + e^{\\beta_0}} = \\frac{exp(-8.643)}{1+exp(-8.643)} = 0.000176$ \n\n\n\nIt is at this point very interesting to notice that:\n\n1. Assumption of blood pressure medications does _not_ reduce the 10 years risk of CHD\n2. Having hypertension has only a small effect on the prediction of developing a risk of CHD in 10 years\n\n**This is a very interesting result from a practical perspective, since it means that generic demographic and physiological variables are much more predictive of the risk of CHD in 10 years with respect to a diagnosis of hypertension, and that the assumption of blood pressure medicaments - presumably to normalize the blood pressure level in people with hypertension - does _not_ reduce the risk of CHD**\n\n\n**Our final model therefore includes:**\n\n- sex\n- age\n- systolic blood pressure \n- glucose\n- cigarettes per day\n\n\nAfterwards, we evaluated the performance of our model on the test data. Using a default probability of 0.5 for binary prediction leads to a poor Sensitivity, in that only ~ 7% of the people with a real 10 year CHD risk ($\\frac{16}{16+219}$) are predicted as being at risk.\n\n**Since in our case the aim is to maximise the detection of people who are truly at risk** - even at expense of inflating the number of false negatives - **we lowered the threshold of binary prediction to 0.1. This allowed us to reach a sensitivity of 84%**.\n\nThe **automatic stepwise regression** (`stepAIC`) identifies the same variables as our final model, plus a small (uncorrected significant) contribution of education level and prevalence of hypertension. However, this model has a smaller AUC (0.703) than our final model, and is also more complex. Therefore we retained our final model.\n\nFinally, we hypothesized that the imbalance between Sensitivity and Specificity could be due to the high proportion of people not at risk in our dataset. Therefore, as a last test, we sampled an equal number of people with and without risk. \n\nIn this **balanced samples model** the AUC increased to 0.738. By using a threshold for binary decision of 0.3, this model correctly predicts 91.4% of the people with actual CHD risk, and a false negative rate of 70%. By adopting a more liberal threshold of 0.4, the model predicts 81.3% of the people with actual CHD, and about 50% of the people with no risk of CHD. \n\n\n**A final remark**\nThis model captures only a fraction of the total variance in the data (~ 15%). It is odd that other variables widely thought to be associated with cardiovascular diseases were not recorded, such as stress level (e.g. # hours of work per day/week), alcohol comsumption, quality of the air.\n\n---\n\n`do_logistic_regression` : a function to carry out the logistic regression and print out the summary of the model, the ROC curve - and the AUC - as well as the confusion matrix.\n\n`plot_ROC` : a function that generates an interactive ROC that allows to inspect  Sensitivity and Specificity for different levels of threshold for binary decision\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndo_logistic_regression <- function(EVs, train_data = train, test_data = test, thresh = 0.5) {\n   \n   # Assemble the formula\n   formula_string <- paste(EVs, collapse = \" + \")\n   formula_obj <- as.formula(paste(\"ten_year_chd ~\", formula_string))\n   \n   fit <- glm(formula_obj, family = \"binomial\", data = train_data)\n\n   \n   # # Standard R summary\n   summary(fit) %>% print()\n   \n   \n   # Print a summary\n   # summary(fit) %>% print()\n   if (length(EVs) > 1) {\n      jtools::summ(fit, confint = T, vifs = T, scale = F, exp = T, digits = 2) %>% print()\n   } else {\n      jtools::summ(fit, confint = T, vifs = T, scale = F, exp = T, digits = 2) %>% print()\n   }\n\n   # Estimated probability values from the logistic model\n   phat = predict(fit, newdata = test_data, type = \"response\")\n\n   # Confusion matrix and derived quantities - using caret::confusionmatrix\n   sprintf(\"\\n Using a threshold for prediction = %.2f \\n\\n\", thresh) %>% cat()\n   \n   thresh <- thresh\n   predicted <- ifelse(phat > thresh, 1, 0)\n   \n   actual_predicted <- tibble(\n      actual = test_data$ten_year_chd, \n      predicted = ifelse(phat > thresh, 1, 0) \n   )\n   \n   caret::confusionMatrix(\n      as.factor(predicted), # predicted\n      as.factor(test_data$ten_year_chd), # actual \n      positive = \"1\"  # the positive class in our case is \"1\"\n   ) %>% print()\n   \n   return(phat)\n}\n\n\nplot_ROC <- function(test_data = test, phat = phat) {\n # Define the probability thresholds you want to use\n   pthresh <- seq(0, 1, 0.1)\n   \n   # Create the ROC curve\n   roc_curve <- roc(test_data$ten_year_chd, phat, plot = F, print.auc=T)\n   \n   # Get the coordinates (sensitivity and specificity) for the specified thresholds\n   coordinates <- pROC::coords(roc_curve, pthresh)\n\n    # Using highcharter\n    h <- coordinates %>% \n    hchart(\n        type = \"line\",\n        hcaes(x = specificity, y = sensitivity, threshold = threshold)\n    ) %>% \n    hc_xAxis(title = list(text = \"Specificity\"), reversed = TRUE, min = 0, max = 1) %>%\n    hc_yAxis(title = list(text = \"Sensitivity\"), min = 0, max = 1) %>% \n    hc_add_series(\n        data = coordinates,\n        type = \"scatter\",\n        hcaes(x = specificity, y = sensitivity, threshold = threshold),\n        marker = list(radius = 6, fillColor = \"lightblue\", lineWidth = 2),\n        tooltip = list(\n            headerFormat = \"\",\n            pointFormat = \"<b>Threshold: {point.threshold:.2f}</b><br>\n                           Sensitivity: {point.y:.2f}<br>\n                           Specificity: {point.x:.2f}\")\n    ) %>% \n     hc_chart(aspectRatio = 1) %>%   # Set the equal aspect ratio\n     hc_title(text = paste(\"ROC curve - AUC =\", round(roc_curve$auc,3)))\n    \n    return(h)\n}\n```\n:::\n\n\n\n## Manual stepwise {.tabset}\n\n### Maximal model\n\nMaximal model, including _all_ the variables in the dataset. We use this only as a benchmark for the models instructed by EDA.\n\nWe observe high VIF values in `sys_bp` and `dia_bp` - as expected. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nEVs <- train %>% select(-ten_year_chd) %>% colnames()\nphat <- do_logistic_regression(EVs, thresh = 0.5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = formula_obj, family = \"binomial\", data = train_data)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-1.8415  -0.5828  -0.4175  -0.2897   2.8226  \n\nCoefficients:\n                    Estimate Std. Error z value Pr(>|z|)    \n(Intercept)       -7.4497344  0.8561698  -8.701  < 2e-16 ***\nmale1              0.3800302  0.1329243   2.859  0.00425 ** \nage                0.0608765  0.0083022   7.333 2.26e-13 ***\neducation2        -0.3243521  0.1517706  -2.137  0.03259 *  \neducation3        -0.3327557  0.1860997  -1.788  0.07377 .  \neducation4        -0.0502180  0.1969542  -0.255  0.79874    \ncurrent_smoker1    0.1717930  0.1922979   0.893  0.37166    \ncigs_per_day       0.0149836  0.0078998   1.897  0.05787 .  \nbp_meds1           0.3755894  0.2932894   1.281  0.20033    \nprevalent_stroke1  0.8294602  0.6158164   1.347  0.17800    \nprevalent_hyp1     0.3669952  0.1660561   2.210  0.02710 *  \ndiabetes1          0.3126526  0.3897172   0.802  0.42241    \ntot_chol           0.0004310  0.0014095   0.306  0.75980    \nsys_bp             0.0121563  0.0046474   2.616  0.00890 ** \ndia_bp             0.0004736  0.0078561   0.060  0.95193    \nbmi                0.0141265  0.0151335   0.933  0.35058    \nheart_rate        -0.0068913  0.0050928  -1.353  0.17601    \nglucose            0.0063839  0.0028683   2.226  0.02604 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 2114.4  on 2470  degrees of freedom\nResidual deviance: 1854.4  on 2453  degrees of freedom\nAIC: 1890.4\n\nNumber of Fisher Scoring iterations: 5\n\nMODEL INFO:\nObservations: 2471\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(17) = 259.91, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.17\nPseudo-R² (McFadden) = 0.12\nAIC = 1890.45, BIC = 1995.07 \n\nStandard errors: MLE\n-------------------------------------------------------------------------\n                          exp(Est.)   2.5%   97.5%   z val.      p    VIF\n----------------------- ----------- ------ ------- -------- ------ ------\n(Intercept)                    0.00   0.00    0.00    -8.70   0.00       \nmale1                          1.46   1.13    1.90     2.86   0.00   1.25\nage                            1.06   1.05    1.08     7.33   0.00   1.32\neducation2                     0.72   0.54    0.97    -2.14   0.03   1.13\neducation3                     0.72   0.50    1.03    -1.79   0.07   1.13\neducation4                     0.95   0.65    1.40    -0.25   0.80   1.13\ncurrent_smoker1                1.19   0.81    1.73     0.89   0.37   2.61\ncigs_per_day                   1.02   1.00    1.03     1.90   0.06   2.74\nbp_meds1                       1.46   0.82    2.59     1.28   0.20   1.11\nprevalent_stroke1              2.29   0.69    7.66     1.35   0.18   1.04\nprevalent_hyp1                 1.44   1.04    2.00     2.21   0.03   1.94\ndiabetes1                      1.37   0.64    2.93     0.80   0.42   1.88\ntot_chol                       1.00   1.00    1.00     0.31   0.76   1.07\nsys_bp                         1.01   1.00    1.02     2.62   0.01   3.64\ndia_bp                         1.00   0.99    1.02     0.06   0.95   2.92\nbmi                            1.01   0.98    1.04     0.93   0.35   1.23\nheart_rate                     0.99   0.98    1.00    -1.35   0.18   1.10\nglucose                        1.01   1.00    1.01     2.23   0.03   1.89\n-------------------------------------------------------------------------\n\n Using a threshold for prediction = 0.50 \n\nConfusion Matrix and Statistics\n\n          Reference\nPrediction    0    1\n         0 1329  213\n         1   16   22\n                                          \n               Accuracy : 0.8551          \n                 95% CI : (0.8367, 0.8721)\n    No Information Rate : 0.8513          \n    P-Value [Acc > NIR] : 0.3513          \n                                          \n                  Kappa : 0.1249          \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.09362         \n            Specificity : 0.98810         \n         Pos Pred Value : 0.57895         \n         Neg Pred Value : 0.86187         \n             Prevalence : 0.14873         \n         Detection Rate : 0.01392         \n   Detection Prevalence : 0.02405         \n      Balanced Accuracy : 0.54086         \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(test, phat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-0b63aea176403bbc7065\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-0b63aea176403bbc7065\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.703\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.456505576208178,\"sensitivity\":0.817021276595745,\"x\":0.456505576208178,\"y\":0.817021276595745},{\"threshold\":0.2,\"specificity\":0.762825278810409,\"sensitivity\":0.527659574468085,\"x\":0.762825278810409,\"y\":0.527659574468085},{\"threshold\":0.3,\"specificity\":0.901115241635688,\"sensitivity\":0.31063829787234,\"x\":0.901115241635688,\"y\":0.31063829787234},{\"threshold\":0.4,\"specificity\":0.962825278810409,\"sensitivity\":0.148936170212766,\"x\":0.962825278810409,\"y\":0.148936170212766},{\"threshold\":0.5,\"specificity\":0.988104089219331,\"sensitivity\":0.0936170212765957,\"x\":0.988104089219331,\"y\":0.0936170212765957},{\"threshold\":0.6,\"specificity\":0.997026022304833,\"sensitivity\":0.0382978723404255,\"x\":0.997026022304833,\"y\":0.0382978723404255},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.456505576208178,\"sensitivity\":0.817021276595745,\"x\":0.456505576208178,\"y\":0.817021276595745},{\"threshold\":0.2,\"specificity\":0.762825278810409,\"sensitivity\":0.527659574468085,\"x\":0.762825278810409,\"y\":0.527659574468085},{\"threshold\":0.3,\"specificity\":0.901115241635688,\"sensitivity\":0.31063829787234,\"x\":0.901115241635688,\"y\":0.31063829787234},{\"threshold\":0.4,\"specificity\":0.962825278810409,\"sensitivity\":0.148936170212766,\"x\":0.962825278810409,\"y\":0.148936170212766},{\"threshold\":0.5,\"specificity\":0.988104089219331,\"sensitivity\":0.0936170212765957,\"x\":0.988104089219331,\"y\":0.0936170212765957},{\"threshold\":0.6,\"specificity\":0.997026022304833,\"sensitivity\":0.0382978723404255,\"x\":0.997026022304833,\"y\":0.0382978723404255},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n\n### Full with selected variables\n\nThis is the \"full\" model with all the variables chosen based on the EDA.\n\nNo problems with collinearity.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nEVs  <- c(\n   \"male\", \"prevalent_hyp\", \"bp_meds\", \"education\",\n   \"age\", \"sys_bp\", \"bmi\", \"glucose\", \"tot_chol\", \"cigs_per_day\"\n)\n\nphat <- do_logistic_regression(EVs, thresh = 0.5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = formula_obj, family = \"binomial\", data = train_data)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-1.9398  -0.5882  -0.4186  -0.2876   2.8221  \n\nCoefficients:\n                 Estimate Std. Error z value Pr(>|z|)    \n(Intercept)    -7.8924235  0.7224553 -10.924  < 2e-16 ***\nmale1           0.3996399  0.1306947   3.058 0.002230 ** \nprevalent_hyp1  0.3564960  0.1628251   2.189 0.028565 *  \nbp_meds1        0.4381388  0.2883448   1.519 0.128638    \neducation2     -0.3319065  0.1512202  -2.195 0.028174 *  \neducation3     -0.3409724  0.1858949  -1.834 0.066621 .  \neducation4     -0.0373354  0.1959238  -0.191 0.848870    \nage             0.0613141  0.0080512   7.616 2.63e-14 ***\nsys_bp          0.0118211  0.0034909   3.386 0.000709 ***\nbmi             0.0137041  0.0146029   0.938 0.348011    \nglucose         0.0075754  0.0021169   3.579 0.000345 ***\ntot_chol        0.0002287  0.0014069   0.163 0.870891    \ncigs_per_day    0.0191629  0.0052321   3.663 0.000250 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 2114.4  on 2470  degrees of freedom\nResidual deviance: 1859.5  on 2458  degrees of freedom\nAIC: 1885.5\n\nNumber of Fisher Scoring iterations: 5\n\nMODEL INFO:\nObservations: 2471\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(12) = 254.88, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.17\nPseudo-R² (McFadden) = 0.12\nAIC = 1885.48, BIC = 1961.04 \n\nStandard errors: MLE\n----------------------------------------------------------------------\n                       exp(Est.)   2.5%   97.5%   z val.      p    VIF\n-------------------- ----------- ------ ------- -------- ------ ------\n(Intercept)                 0.00   0.00    0.00   -10.92   0.00       \nmale1                       1.49   1.15    1.93     3.06   0.00   1.21\nprevalent_hyp1              1.43   1.04    1.97     2.19   0.03   1.87\nbp_meds1                    1.55   0.88    2.73     1.52   0.13   1.09\neducation2                  0.72   0.53    0.97    -2.19   0.03   1.11\neducation3                  0.71   0.49    1.02    -1.83   0.07   1.11\neducation4                  0.96   0.66    1.41    -0.19   0.85   1.11\nage                         1.06   1.05    1.08     7.62   0.00   1.25\nsys_bp                      1.01   1.00    1.02     3.39   0.00   2.06\nbmi                         1.01   0.99    1.04     0.94   0.35   1.16\nglucose                     1.01   1.00    1.01     3.58   0.00   1.02\ntot_chol                    1.00   1.00    1.00     0.16   0.87   1.06\ncigs_per_day                1.02   1.01    1.03     3.66   0.00   1.22\n----------------------------------------------------------------------\n\n Using a threshold for prediction = 0.50 \n\nConfusion Matrix and Statistics\n\n          Reference\nPrediction    0    1\n         0 1332  219\n         1   13   16\n                                          \n               Accuracy : 0.8532          \n                 95% CI : (0.8347, 0.8703)\n    No Information Rate : 0.8513          \n    P-Value [Acc > NIR] : 0.433           \n                                          \n                  Kappa : 0.0915          \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.06809         \n            Specificity : 0.99033         \n         Pos Pred Value : 0.55172         \n         Neg Pred Value : 0.85880         \n             Prevalence : 0.14873         \n         Detection Rate : 0.01013         \n   Detection Prevalence : 0.01835         \n      Balanced Accuracy : 0.52921         \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(test, phat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-d87621ab39711deb7f87\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-d87621ab39711deb7f87\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.705\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.452788104089219,\"sensitivity\":0.825531914893617,\"x\":0.452788104089219,\"y\":0.825531914893617},{\"threshold\":0.2,\"specificity\":0.765799256505576,\"sensitivity\":0.514893617021277,\"x\":0.765799256505576,\"y\":0.514893617021277},{\"threshold\":0.3,\"specificity\":0.89814126394052,\"sensitivity\":0.306382978723404,\"x\":0.89814126394052,\"y\":0.306382978723404},{\"threshold\":0.4,\"specificity\":0.963568773234201,\"sensitivity\":0.153191489361702,\"x\":0.963568773234201,\"y\":0.153191489361702},{\"threshold\":0.5,\"specificity\":0.990334572490706,\"sensitivity\":0.0680851063829787,\"x\":0.990334572490706,\"y\":0.0680851063829787},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0425531914893617,\"x\":0.998513011152416,\"y\":0.0425531914893617},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.452788104089219,\"sensitivity\":0.825531914893617,\"x\":0.452788104089219,\"y\":0.825531914893617},{\"threshold\":0.2,\"specificity\":0.765799256505576,\"sensitivity\":0.514893617021277,\"x\":0.765799256505576,\"y\":0.514893617021277},{\"threshold\":0.3,\"specificity\":0.89814126394052,\"sensitivity\":0.306382978723404,\"x\":0.89814126394052,\"y\":0.306382978723404},{\"threshold\":0.4,\"specificity\":0.963568773234201,\"sensitivity\":0.153191489361702,\"x\":0.963568773234201,\"y\":0.153191489361702},{\"threshold\":0.5,\"specificity\":0.990334572490706,\"sensitivity\":0.0680851063829787,\"x\":0.990334572490706,\"y\":0.0680851063829787},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0425531914893617,\"x\":0.998513011152416,\"y\":0.0425531914893617},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n\n### Remove no-effect EVs\n\nRemove education, bp_meds, bmi, tot_chol since they have\nno effect on the model.\n\nThe AIC slightly decreases with respect to the full model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Remove education, bp_meds, bmi, tot_chol since they have\n# no effect on the model\nEVs  <- c(\n   \"male\", \"prevalent_hyp\",\n   \"age\", \"sys_bp\", \"glucose\", \"cigs_per_day\"\n)\n\nphat <- do_logistic_regression(EVs, thresh = 0.5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = formula_obj, family = \"binomial\", data = train_data)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-2.1088  -0.5889  -0.4241  -0.2951   2.7635  \n\nCoefficients:\n                Estimate Std. Error z value Pr(>|z|)    \n(Intercept)    -8.027822   0.562910 -14.261  < 2e-16 ***\nmale1           0.434934   0.127776   3.404 0.000664 ***\nprevalent_hyp1  0.387263   0.160552   2.412 0.015862 *  \nage             0.064891   0.007775   8.346  < 2e-16 ***\nsys_bp          0.013408   0.003393   3.952 7.76e-05 ***\nglucose         0.007572   0.002106   3.595 0.000324 ***\ncigs_per_day    0.018188   0.005197   3.500 0.000465 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 2114.4  on 2470  degrees of freedom\nResidual deviance: 1870.0  on 2464  degrees of freedom\nAIC: 1884\n\nNumber of Fisher Scoring iterations: 5\n\nMODEL INFO:\nObservations: 2471\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(6) = 244.31, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.16\nPseudo-R² (McFadden) = 0.12\nAIC = 1884.05, BIC = 1924.73 \n\nStandard errors: MLE\n----------------------------------------------------------------------\n                       exp(Est.)   2.5%   97.5%   z val.      p    VIF\n-------------------- ----------- ------ ------- -------- ------ ------\n(Intercept)                 0.00   0.00    0.00   -14.26   0.00       \nmale1                       1.54   1.20    1.98     3.40   0.00   1.16\nprevalent_hyp1              1.47   1.08    2.02     2.41   0.02   1.83\nage                         1.07   1.05    1.08     8.35   0.00   1.17\nsys_bp                      1.01   1.01    1.02     3.95   0.00   1.95\nglucose                     1.01   1.00    1.01     3.60   0.00   1.01\ncigs_per_day                1.02   1.01    1.03     3.50   0.00   1.21\n----------------------------------------------------------------------\n\n Using a threshold for prediction = 0.50 \n\nConfusion Matrix and Statistics\n\n          Reference\nPrediction    0    1\n         0 1335  219\n         1   10   16\n                                          \n               Accuracy : 0.8551          \n                 95% CI : (0.8367, 0.8721)\n    No Information Rate : 0.8513          \n    P-Value [Acc > NIR] : 0.3513          \n                                          \n                  Kappa : 0.0958          \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.06809         \n            Specificity : 0.99257         \n         Pos Pred Value : 0.61538         \n         Neg Pred Value : 0.85907         \n             Prevalence : 0.14873         \n         Detection Rate : 0.01013         \n   Detection Prevalence : 0.01646         \n      Balanced Accuracy : 0.53033         \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(test, phat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-f5257eaf263dbafcaad2\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-f5257eaf263dbafcaad2\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.711\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.446840148698885,\"sensitivity\":0.825531914893617,\"x\":0.446840148698885,\"y\":0.825531914893617},{\"threshold\":0.2,\"specificity\":0.762825278810409,\"sensitivity\":0.523404255319149,\"x\":0.762825278810409,\"y\":0.523404255319149},{\"threshold\":0.3,\"specificity\":0.90185873605948,\"sensitivity\":0.327659574468085,\"x\":0.90185873605948,\"y\":0.327659574468085},{\"threshold\":0.4,\"specificity\":0.968029739776952,\"sensitivity\":0.161702127659574,\"x\":0.968029739776952,\"y\":0.161702127659574},{\"threshold\":0.5,\"specificity\":0.992565055762082,\"sensitivity\":0.0680851063829787,\"x\":0.992565055762082,\"y\":0.0680851063829787},{\"threshold\":0.6,\"specificity\":0.997769516728625,\"sensitivity\":0.025531914893617,\"x\":0.997769516728625,\"y\":0.025531914893617},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.446840148698885,\"sensitivity\":0.825531914893617,\"x\":0.446840148698885,\"y\":0.825531914893617},{\"threshold\":0.2,\"specificity\":0.762825278810409,\"sensitivity\":0.523404255319149,\"x\":0.762825278810409,\"y\":0.523404255319149},{\"threshold\":0.3,\"specificity\":0.90185873605948,\"sensitivity\":0.327659574468085,\"x\":0.90185873605948,\"y\":0.327659574468085},{\"threshold\":0.4,\"specificity\":0.968029739776952,\"sensitivity\":0.161702127659574,\"x\":0.968029739776952,\"y\":0.161702127659574},{\"threshold\":0.5,\"specificity\":0.992565055762082,\"sensitivity\":0.0680851063829787,\"x\":0.992565055762082,\"y\":0.0680851063829787},{\"threshold\":0.6,\"specificity\":0.997769516728625,\"sensitivity\":0.025531914893617,\"x\":0.997769516728625,\"y\":0.025531914893617},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n\n### Remove prevalent_hyp\n\nRemove prevalent_hyp since it is only marginally significant\n\nNote that the AIC only marginally increases (less than 0.2%) and this model is much simpler and requires only 4 variables, two of which are common demographic variables (`age` and sex), while the other two can be easily gathered through a pressure measurement and a blood test.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Remove prevalent_hyp since it is only marginally significant\nEVs  <- c(\n   \"male\", \"age\", \"sys_bp\", \"glucose\", \"cigs_per_day\"\n)\n\nphat <- do_logistic_regression(EVs, thresh = 0.5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = formula_obj, family = \"binomial\", data = train_data)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-2.1053  -0.5899  -0.4330  -0.2982   2.8162  \n\nCoefficients:\n              Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -8.643579   0.504565 -17.131  < 2e-16 ***\nmale1         0.449590   0.127385   3.529 0.000417 ***\nage           0.065845   0.007745   8.502  < 2e-16 ***\nsys_bp        0.018684   0.002597   7.194 6.29e-13 ***\nglucose       0.007547   0.002112   3.573 0.000353 ***\ncigs_per_day  0.017858   0.005184   3.445 0.000571 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 2114.4  on 2470  degrees of freedom\nResidual deviance: 1875.8  on 2465  degrees of freedom\nAIC: 1887.8\n\nNumber of Fisher Scoring iterations: 5\n\nMODEL INFO:\nObservations: 2471\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(5) = 238.54, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.16\nPseudo-R² (McFadden) = 0.11\nAIC = 1887.82, BIC = 1922.69 \n\nStandard errors: MLE\n--------------------------------------------------------------------\n                     exp(Est.)   2.5%   97.5%   z val.      p    VIF\n------------------ ----------- ------ ------- -------- ------ ------\n(Intercept)               0.00   0.00    0.00   -17.13   0.00       \nmale1                     1.57   1.22    2.01     3.53   0.00   1.16\nage                       1.07   1.05    1.08     8.50   0.00   1.17\nsys_bp                    1.02   1.01    1.02     7.19   0.00   1.14\nglucose                   1.01   1.00    1.01     3.57   0.00   1.01\ncigs_per_day              1.02   1.01    1.03     3.44   0.00   1.20\n--------------------------------------------------------------------\n\n Using a threshold for prediction = 0.50 \n\nConfusion Matrix and Statistics\n\n          Reference\nPrediction    0    1\n         0 1337  219\n         1    8   16\n                                          \n               Accuracy : 0.8563          \n                 95% CI : (0.8381, 0.8733)\n    No Information Rate : 0.8513          \n    P-Value [Acc > NIR] : 0.3             \n                                          \n                  Kappa : 0.0987          \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.06809         \n            Specificity : 0.99405         \n         Pos Pred Value : 0.66667         \n         Neg Pred Value : 0.85925         \n             Prevalence : 0.14873         \n         Detection Rate : 0.01013         \n   Detection Prevalence : 0.01519         \n      Balanced Accuracy : 0.53107         \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(test, phat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-11cad29016a2f7ef2835\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-11cad29016a2f7ef2835\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.713\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.43271375464684,\"sensitivity\":0.842553191489362,\"x\":0.43271375464684,\"y\":0.842553191489362},{\"threshold\":0.2,\"specificity\":0.769516728624535,\"sensitivity\":0.523404255319149,\"x\":0.769516728624535,\"y\":0.523404255319149},{\"threshold\":0.3,\"specificity\":0.901115241635688,\"sensitivity\":0.28936170212766,\"x\":0.901115241635688,\"y\":0.28936170212766},{\"threshold\":0.4,\"specificity\":0.971003717472119,\"sensitivity\":0.153191489361702,\"x\":0.971003717472119,\"y\":0.153191489361702},{\"threshold\":0.5,\"specificity\":0.994052044609665,\"sensitivity\":0.0680851063829787,\"x\":0.994052044609665,\"y\":0.0680851063829787},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0340425531914894,\"x\":0.998513011152416,\"y\":0.0340425531914894},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.43271375464684,\"sensitivity\":0.842553191489362,\"x\":0.43271375464684,\"y\":0.842553191489362},{\"threshold\":0.2,\"specificity\":0.769516728624535,\"sensitivity\":0.523404255319149,\"x\":0.769516728624535,\"y\":0.523404255319149},{\"threshold\":0.3,\"specificity\":0.901115241635688,\"sensitivity\":0.28936170212766,\"x\":0.901115241635688,\"y\":0.28936170212766},{\"threshold\":0.4,\"specificity\":0.971003717472119,\"sensitivity\":0.153191489361702,\"x\":0.971003717472119,\"y\":0.153191489361702},{\"threshold\":0.5,\"specificity\":0.994052044609665,\"sensitivity\":0.0680851063829787,\"x\":0.994052044609665,\"y\":0.0680851063829787},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0340425531914894,\"x\":0.998513011152416,\"y\":0.0340425531914894},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n\n### Assess categorical interactions\n\nThe number of cigarettes per day is a relevant factor, although being a current smoker is not. Since there is an interaction between being male, current smoker and having hypertension, it is worth exploring whether including these interactions would improve the performance of the model.\n\nHowever, the results show that the coefficients associated with `male:current_smoker` and `current_smoker:prevalent_hyp` are not significant - especially after correction. Also, they are highly collinear with `cigs_per_day` - which becomes not significant - and do not improve the model performance. \n\nFor all these resasons, these interactions will _not_ be included in the final model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Try to include `male:current_smoker` and `current_smoker:prevalent_hyp`\nEVs  <- c(\n   \"male\", \"age\", \"sys_bp\", \"glucose\", \"male:current_smoker\", \"current_smoker:prevalent_hyp\"\n)\n\nphat <- do_logistic_regression(EVs, thresh = 0.5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = formula_obj, family = \"binomial\", data = train_data)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-2.0959  -0.5871  -0.4262  -0.2940   2.7761  \n\nCoefficients:\n                                Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                    -8.071834   0.575043 -14.037  < 2e-16 ***\nmale1                           0.411137   0.177391   2.318 0.020466 *  \nage                             0.064531   0.007790   8.284  < 2e-16 ***\nsys_bp                          0.013450   0.003398   3.959 7.54e-05 ***\nglucose                         0.007486   0.002101   3.563 0.000367 ***\nmale0:current_smoker1           0.386439   0.213094   1.813 0.069760 .  \nmale1:current_smoker1           0.560270   0.206397   2.715 0.006637 ** \ncurrent_smoker0:prevalent_hyp1  0.472103   0.200758   2.352 0.018693 *  \ncurrent_smoker1:prevalent_hyp1  0.287916   0.201998   1.425 0.154058    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 2114.4  on 2470  degrees of freedom\nResidual deviance: 1871.3  on 2462  degrees of freedom\nAIC: 1889.3\n\nNumber of Fisher Scoring iterations: 5\n\nMODEL INFO:\nObservations: 2471\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(8) = 243.03, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.16\nPseudo-R² (McFadden) = 0.11\nAIC = 1889.32, BIC = 1941.64 \n\nStandard errors: MLE\n-------------------------------------------------------------------------------\n                                       exp(Est.)   2.5%   97.5%   z val.      p\n------------------------------------ ----------- ------ ------- -------- ------\n(Intercept)                                 0.00   0.00    0.00   -14.04   0.00\nmale1                                       1.51   1.07    2.14     2.32   0.02\nage                                         1.07   1.05    1.08     8.28   0.00\nsys_bp                                      1.01   1.01    1.02     3.96   0.00\nglucose                                     1.01   1.00    1.01     3.56   0.00\nmale0:current_smoker1                       1.47   0.97    2.23     1.81   0.07\nmale1:current_smoker1                       1.75   1.17    2.62     2.71   0.01\ncurrent_smoker0:prevalent_hyp1              1.60   1.08    2.38     2.35   0.02\ncurrent_smoker1:prevalent_hyp1              1.33   0.90    1.98     1.43   0.15\n-------------------------------------------------------------------------------\n \n-------------------------------------------\n                                        VIF\n------------------------------------ ------\n(Intercept)                                \nmale1                                  2.24\nage                                    1.18\nsys_bp                                 1.96\nglucose                                1.01\nmale0:current_smoker1                  4.18\nmale1:current_smoker1                  4.18\ncurrent_smoker0:prevalent_hyp1         3.57\ncurrent_smoker1:prevalent_hyp1         3.57\n-------------------------------------------\n\n Using a threshold for prediction = 0.50 \n\nConfusion Matrix and Statistics\n\n          Reference\nPrediction    0    1\n         0 1332  221\n         1   13   14\n                                          \n               Accuracy : 0.8519          \n                 95% CI : (0.8334, 0.8691)\n    No Information Rate : 0.8513          \n    P-Value [Acc > NIR] : 0.4892          \n                                          \n                  Kappa : 0.0786          \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.059574        \n            Specificity : 0.990335        \n         Pos Pred Value : 0.518519        \n         Neg Pred Value : 0.857695        \n             Prevalence : 0.148734        \n         Detection Rate : 0.008861        \n   Detection Prevalence : 0.017089        \n      Balanced Accuracy : 0.524955        \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(test, phat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-62a3b6c2f35e3ffc5dda\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-62a3b6c2f35e3ffc5dda\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.707\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.453531598513011,\"sensitivity\":0.834042553191489,\"x\":0.453531598513011,\"y\":0.834042553191489},{\"threshold\":0.2,\"specificity\":0.763568773234201,\"sensitivity\":0.51063829787234,\"x\":0.763568773234201,\"y\":0.51063829787234},{\"threshold\":0.3,\"specificity\":0.898884758364312,\"sensitivity\":0.323404255319149,\"x\":0.898884758364312,\"y\":0.323404255319149},{\"threshold\":0.4,\"specificity\":0.964312267657993,\"sensitivity\":0.161702127659574,\"x\":0.964312267657993,\"y\":0.161702127659574},{\"threshold\":0.5,\"specificity\":0.990334572490706,\"sensitivity\":0.0595744680851064,\"x\":0.990334572490706,\"y\":0.0595744680851064},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0170212765957447,\"x\":0.998513011152416,\"y\":0.0170212765957447},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.453531598513011,\"sensitivity\":0.834042553191489,\"x\":0.453531598513011,\"y\":0.834042553191489},{\"threshold\":0.2,\"specificity\":0.763568773234201,\"sensitivity\":0.51063829787234,\"x\":0.763568773234201,\"y\":0.51063829787234},{\"threshold\":0.3,\"specificity\":0.898884758364312,\"sensitivity\":0.323404255319149,\"x\":0.898884758364312,\"y\":0.323404255319149},{\"threshold\":0.4,\"specificity\":0.964312267657993,\"sensitivity\":0.161702127659574,\"x\":0.964312267657993,\"y\":0.161702127659574},{\"threshold\":0.5,\"specificity\":0.990334572490706,\"sensitivity\":0.0595744680851064,\"x\":0.990334572490706,\"y\":0.0595744680851064},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0170212765957447,\"x\":0.998513011152416,\"y\":0.0170212765957447},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n\n### Sigmoid for age\n\nWe also decided to try to model age as a sigmoid, under the assumption that the odds of a CHD risk in ten years were overall smaller for people < 40 and would increase at a steeper rate afterwards, however the perfomance of the model did not change. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsigmoid_function <- function(x, a, b, c, d) {\n  # Sigmoid function formula: a + (b - a) / (1 + exp(-c * (x - d)))\n  return(a + (b - a) / (1 + exp(-c * (x - d))))\n}\n\n# Define the parameters for the sigmoid function to control the curve\na_linear <- 0      # Start value (linear increase starts from 0)\nb_linear <- 1      # End value of linear increase (1 represents 100%)\nc_steepness <- 0.15 # Steepness factor for the sigmoid curve (adjust as needed)\nd_transition <- 50 # Age at which the transition occurs (50 in your case)\n\n\ntrain_sigmoid_age <- train %>% \n mutate(age_sigmoid = sigmoid_function(age, a_linear, b_linear, c_steepness, d_transition))\n\ntest_sigmoid_age <- test %>% \n mutate(age_sigmoid = sigmoid_function(age, a_linear, b_linear, c_steepness, d_transition))\n\n\nplot(train_sigmoid_age$age, train_sigmoid_age$age_sigmoid)\n```\n\n::: {.cell-output-display}\n![](Graded_Task_Logistic_Regression_V5_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# The proxy_age variable now has a smooth transition, increasing linearly until 50 and more steeply after that.\n\n\n\nEVs  <- c(\n   \"male\", \"age_sigmoid\", \"sys_bp\", \"glucose\", \"cigs_per_day\"\n)\n\nphat <- do_logistic_regression(\n train_data = train_sigmoid_age,\n test_data = test_sigmoid_age,\n EVs, thresh = 0.1\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = formula_obj, family = \"binomial\", data = train_data)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-2.0739  -0.5929  -0.4279  -0.2942   2.7784  \n\nCoefficients:\n              Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -6.433353   0.401903 -16.007  < 2e-16 ***\nmale1         0.449367   0.127351   3.529 0.000418 ***\nage_sigmoid   2.197337   0.258184   8.511  < 2e-16 ***\nsys_bp        0.018622   0.002598   7.167 7.64e-13 ***\nglucose       0.007502   0.002109   3.556 0.000376 ***\ncigs_per_day  0.017897   0.005184   3.452 0.000556 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 2114.4  on 2470  degrees of freedom\nResidual deviance: 1874.9  on 2465  degrees of freedom\nAIC: 1886.9\n\nNumber of Fisher Scoring iterations: 5\n\nMODEL INFO:\nObservations: 2471\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(5) = 239.49, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.16\nPseudo-R² (McFadden) = 0.11\nAIC = 1886.87, BIC = 1921.74 \n\nStandard errors: MLE\n--------------------------------------------------------------------\n                     exp(Est.)   2.5%   97.5%   z val.      p    VIF\n------------------ ----------- ------ ------- -------- ------ ------\n(Intercept)               0.00   0.00    0.00   -16.01   0.00       \nmale1                     1.57   1.22    2.01     3.53   0.00   1.16\nage_sigmoid               9.00   5.43   14.93     8.51   0.00   1.17\nsys_bp                    1.02   1.01    1.02     7.17   0.00   1.14\nglucose                   1.01   1.00    1.01     3.56   0.00   1.01\ncigs_per_day              1.02   1.01    1.03     3.45   0.00   1.20\n--------------------------------------------------------------------\n\n Using a threshold for prediction = 0.10 \n\nConfusion Matrix and Statistics\n\n          Reference\nPrediction   0   1\n         0 584  39\n         1 761 196\n                                          \n               Accuracy : 0.4937          \n                 95% CI : (0.4687, 0.5186)\n    No Information Rate : 0.8513          \n    P-Value [Acc > NIR] : 1               \n                                          \n                  Kappa : 0.1183          \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.8340          \n            Specificity : 0.4342          \n         Pos Pred Value : 0.2048          \n         Neg Pred Value : 0.9374          \n             Prevalence : 0.1487          \n         Detection Rate : 0.1241          \n   Detection Prevalence : 0.6057          \n      Balanced Accuracy : 0.6341          \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(test_sigmoid_age, phat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-4af0b936ccf1f577638e\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-4af0b936ccf1f577638e\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.712\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.434200743494424,\"sensitivity\":0.834042553191489,\"x\":0.434200743494424,\"y\":0.834042553191489},{\"threshold\":0.2,\"specificity\":0.761338289962825,\"sensitivity\":0.531914893617021,\"x\":0.761338289962825,\"y\":0.531914893617021},{\"threshold\":0.3,\"specificity\":0.899628252788104,\"sensitivity\":0.276595744680851,\"x\":0.899628252788104,\"y\":0.276595744680851},{\"threshold\":0.4,\"specificity\":0.971003717472119,\"sensitivity\":0.148936170212766,\"x\":0.971003717472119,\"y\":0.148936170212766},{\"threshold\":0.5,\"specificity\":0.994052044609665,\"sensitivity\":0.0553191489361702,\"x\":0.994052044609665,\"y\":0.0553191489361702},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.025531914893617,\"x\":0.998513011152416,\"y\":0.025531914893617},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.434200743494424,\"sensitivity\":0.834042553191489,\"x\":0.434200743494424,\"y\":0.834042553191489},{\"threshold\":0.2,\"specificity\":0.761338289962825,\"sensitivity\":0.531914893617021,\"x\":0.761338289962825,\"y\":0.531914893617021},{\"threshold\":0.3,\"specificity\":0.899628252788104,\"sensitivity\":0.276595744680851,\"x\":0.899628252788104,\"y\":0.276595744680851},{\"threshold\":0.4,\"specificity\":0.971003717472119,\"sensitivity\":0.148936170212766,\"x\":0.971003717472119,\"y\":0.148936170212766},{\"threshold\":0.5,\"specificity\":0.994052044609665,\"sensitivity\":0.0553191489361702,\"x\":0.994052044609665,\"y\":0.0553191489361702},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.025531914893617,\"x\":0.998513011152416,\"y\":0.025531914893617},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n\n\n\n### Final model using thr = 0.5\n\nWe decided to include the following variables in the final model:\n\n- male\n- age\n- sys_bp\n- glucose\n- cigs_per_day\n\nAt this point, we evaluate the performance of the model in terms of sensitivity (TP/TP+FN) using a default threshold of 0.5 for binary decision on the test set.\n\nOur aim is to maximise the amount of people at risk which are predicted to be so by the model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# The main aim is to use the model to identify the highest amount of true positives\n# and minimize false negatives\n\nEVs  <- c(\n   \"male\", \"age\", \"sys_bp\", \"glucose\", \"cigs_per_day\"\n)\n\nphat <- do_logistic_regression(EVs, thresh = 0.5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = formula_obj, family = \"binomial\", data = train_data)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-2.1053  -0.5899  -0.4330  -0.2982   2.8162  \n\nCoefficients:\n              Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -8.643579   0.504565 -17.131  < 2e-16 ***\nmale1         0.449590   0.127385   3.529 0.000417 ***\nage           0.065845   0.007745   8.502  < 2e-16 ***\nsys_bp        0.018684   0.002597   7.194 6.29e-13 ***\nglucose       0.007547   0.002112   3.573 0.000353 ***\ncigs_per_day  0.017858   0.005184   3.445 0.000571 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 2114.4  on 2470  degrees of freedom\nResidual deviance: 1875.8  on 2465  degrees of freedom\nAIC: 1887.8\n\nNumber of Fisher Scoring iterations: 5\n\nMODEL INFO:\nObservations: 2471\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(5) = 238.54, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.16\nPseudo-R² (McFadden) = 0.11\nAIC = 1887.82, BIC = 1922.69 \n\nStandard errors: MLE\n--------------------------------------------------------------------\n                     exp(Est.)   2.5%   97.5%   z val.      p    VIF\n------------------ ----------- ------ ------- -------- ------ ------\n(Intercept)               0.00   0.00    0.00   -17.13   0.00       \nmale1                     1.57   1.22    2.01     3.53   0.00   1.16\nage                       1.07   1.05    1.08     8.50   0.00   1.17\nsys_bp                    1.02   1.01    1.02     7.19   0.00   1.14\nglucose                   1.01   1.00    1.01     3.57   0.00   1.01\ncigs_per_day              1.02   1.01    1.03     3.44   0.00   1.20\n--------------------------------------------------------------------\n\n Using a threshold for prediction = 0.50 \n\nConfusion Matrix and Statistics\n\n          Reference\nPrediction    0    1\n         0 1337  219\n         1    8   16\n                                          \n               Accuracy : 0.8563          \n                 95% CI : (0.8381, 0.8733)\n    No Information Rate : 0.8513          \n    P-Value [Acc > NIR] : 0.3             \n                                          \n                  Kappa : 0.0987          \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.06809         \n            Specificity : 0.99405         \n         Pos Pred Value : 0.66667         \n         Neg Pred Value : 0.85925         \n             Prevalence : 0.14873         \n         Detection Rate : 0.01013         \n   Detection Prevalence : 0.01519         \n      Balanced Accuracy : 0.53107         \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(test, phat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-1d9a1a0ff105765838a8\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-1d9a1a0ff105765838a8\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.713\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.43271375464684,\"sensitivity\":0.842553191489362,\"x\":0.43271375464684,\"y\":0.842553191489362},{\"threshold\":0.2,\"specificity\":0.769516728624535,\"sensitivity\":0.523404255319149,\"x\":0.769516728624535,\"y\":0.523404255319149},{\"threshold\":0.3,\"specificity\":0.901115241635688,\"sensitivity\":0.28936170212766,\"x\":0.901115241635688,\"y\":0.28936170212766},{\"threshold\":0.4,\"specificity\":0.971003717472119,\"sensitivity\":0.153191489361702,\"x\":0.971003717472119,\"y\":0.153191489361702},{\"threshold\":0.5,\"specificity\":0.994052044609665,\"sensitivity\":0.0680851063829787,\"x\":0.994052044609665,\"y\":0.0680851063829787},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0340425531914894,\"x\":0.998513011152416,\"y\":0.0340425531914894},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.43271375464684,\"sensitivity\":0.842553191489362,\"x\":0.43271375464684,\"y\":0.842553191489362},{\"threshold\":0.2,\"specificity\":0.769516728624535,\"sensitivity\":0.523404255319149,\"x\":0.769516728624535,\"y\":0.523404255319149},{\"threshold\":0.3,\"specificity\":0.901115241635688,\"sensitivity\":0.28936170212766,\"x\":0.901115241635688,\"y\":0.28936170212766},{\"threshold\":0.4,\"specificity\":0.971003717472119,\"sensitivity\":0.153191489361702,\"x\":0.971003717472119,\"y\":0.153191489361702},{\"threshold\":0.5,\"specificity\":0.994052044609665,\"sensitivity\":0.0680851063829787,\"x\":0.994052044609665,\"y\":0.0680851063829787},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0340425531914894,\"x\":0.998513011152416,\"y\":0.0340425531914894},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n\n### Final model using thr = 0.1\n\nLeaving the default threshold of 0.5 for binary prediction leads to identifying too few true positives. For this reason, we decided to maximise the Sensitivity (TP / (TP+FN)) even at the expense of assigning high risk of CHD to some people who are not.\n\nThis rationale is motivated by the fact that in this case the decision is not about doing or not doing an open-heart surgery, but rather to start to monitor people who might be at high risk. Plus, according the to the model, an accurate monitoring only requires inexpensive procedures: blood test and pressure measurements. \n\nFor this reason, it is of paramount important to include all the people who might be at risk even if they will turn out not to be so.\n\nThe threshold for risk detection is accordingly lowered to 0.1.\n\nThis leads to determine that almost 50% of the people who are _not_ at risk will be deemed to be actually at risk. However, this choice will lead to a Sensitivity of about 80%. \n\nNB: We also replace the `cigs_per_day` with units of tens of cigarettes\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# The main aim is to use the model to identify the highest amount of true positives\n# and minimize false negatives\n\n# EVs  <- c(\n#    \"male\", \"age\", \"sys_bp\", \"glucose\", \"cigs_per_day\"\n# )\n# \n# phat <- do_logistic_regression(EVs, thresh = 0.1)\n\n\ntrain_cig_factor <- train %>% \n mutate(tens_cigs = round(cigs_per_day/10,0))\n\ntest_cig_factor <- test %>% \n mutate(tens_cigs = round(cigs_per_day/10,0))\n\n\nEVs  <- c(\n   \"male\", \"age\", \"sys_bp\", \"glucose\", \"tens_cigs\"\n)\n\nphat <- do_logistic_regression(\n EVs, \n train_data = train_cig_factor, \n test_data = test_cig_factor, \n thresh = 0.1\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = formula_obj, family = \"binomial\", data = train_data)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-2.1007  -0.5886  -0.4341  -0.2981   2.8165  \n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept) -8.636592   0.503982 -17.137  < 2e-16 ***\nmale1        0.448757   0.127401   3.522 0.000428 ***\nage          0.065813   0.007742   8.501  < 2e-16 ***\nsys_bp       0.018675   0.002597   7.191 6.45e-13 ***\nglucose      0.007510   0.002108   3.562 0.000368 ***\ntens_cigs    0.176640   0.051338   3.441 0.000580 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 2114.4  on 2470  degrees of freedom\nResidual deviance: 1875.8  on 2465  degrees of freedom\nAIC: 1887.8\n\nNumber of Fisher Scoring iterations: 5\n\nMODEL INFO:\nObservations: 2471\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(5) = 238.54, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.16\nPseudo-R² (McFadden) = 0.11\nAIC = 1887.81, BIC = 1922.69 \n\nStandard errors: MLE\n-------------------------------------------------------------------\n                    exp(Est.)   2.5%   97.5%   z val.      p    VIF\n----------------- ----------- ------ ------- -------- ------ ------\n(Intercept)              0.00   0.00    0.00   -17.14   0.00       \nmale1                    1.57   1.22    2.01     3.52   0.00   1.16\nage                      1.07   1.05    1.08     8.50   0.00   1.17\nsys_bp                   1.02   1.01    1.02     7.19   0.00   1.14\nglucose                  1.01   1.00    1.01     3.56   0.00   1.01\ntens_cigs                1.19   1.08    1.32     3.44   0.00   1.20\n-------------------------------------------------------------------\n\n Using a threshold for prediction = 0.10 \n\nConfusion Matrix and Statistics\n\n          Reference\nPrediction   0   1\n         0 588  38\n         1 757 197\n                                          \n               Accuracy : 0.4968          \n                 95% CI : (0.4719, 0.5218)\n    No Information Rate : 0.8513          \n    P-Value [Acc > NIR] : 1               \n                                          \n                  Kappa : 0.1218          \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.8383          \n            Specificity : 0.4372          \n         Pos Pred Value : 0.2065          \n         Neg Pred Value : 0.9393          \n             Prevalence : 0.1487          \n         Detection Rate : 0.1247          \n   Detection Prevalence : 0.6038          \n      Balanced Accuracy : 0.6377          \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(test, phat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-38a7e4c6725b331f3179\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-38a7e4c6725b331f3179\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.713\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.437174721189591,\"sensitivity\":0.838297872340426,\"x\":0.437174721189591,\"y\":0.838297872340426},{\"threshold\":0.2,\"specificity\":0.771003717472119,\"sensitivity\":0.527659574468085,\"x\":0.771003717472119,\"y\":0.527659574468085},{\"threshold\":0.3,\"specificity\":0.90185873605948,\"sensitivity\":0.293617021276596,\"x\":0.90185873605948,\"y\":0.293617021276596},{\"threshold\":0.4,\"specificity\":0.971003717472119,\"sensitivity\":0.153191489361702,\"x\":0.971003717472119,\"y\":0.153191489361702},{\"threshold\":0.5,\"specificity\":0.994052044609665,\"sensitivity\":0.0723404255319149,\"x\":0.994052044609665,\"y\":0.0723404255319149},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0340425531914894,\"x\":0.998513011152416,\"y\":0.0340425531914894},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.437174721189591,\"sensitivity\":0.838297872340426,\"x\":0.437174721189591,\"y\":0.838297872340426},{\"threshold\":0.2,\"specificity\":0.771003717472119,\"sensitivity\":0.527659574468085,\"x\":0.771003717472119,\"y\":0.527659574468085},{\"threshold\":0.3,\"specificity\":0.90185873605948,\"sensitivity\":0.293617021276596,\"x\":0.90185873605948,\"y\":0.293617021276596},{\"threshold\":0.4,\"specificity\":0.971003717472119,\"sensitivity\":0.153191489361702,\"x\":0.971003717472119,\"y\":0.153191489361702},{\"threshold\":0.5,\"specificity\":0.994052044609665,\"sensitivity\":0.0723404255319149,\"x\":0.994052044609665,\"y\":0.0723404255319149},{\"threshold\":0.6,\"specificity\":0.998513011152416,\"sensitivity\":0.0340425531914894,\"x\":0.998513011152416,\"y\":0.0340425531914894},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0127659574468085,\"x\":1,\"y\":0.0127659574468085},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n\n\n\n\n\nCode to manually calculate the Confusion Matrix and its derivatives. Values are not shown. This was just an excercise.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# # Binary prediction from the estimated probability values \n# thresh <- 0.1\n# predicted <- ifelse(phat > thresh, 1, 0)\n# \n# actual_predicted <- tibble(\n#    actual = test$ten_year_chd, \n#    predicted = ifelse(phat > thresh, 1, 0) \n# )\n# \n# cm <- actual_predicted %>%\n#   summarise(\n#     TP = sum(actual == 1 & predicted == 1),\n#     TN = sum(actual == 0 & predicted == 0),\n#     FP = sum(actual == 0 & predicted == 1),\n#     FN = sum(actual == 1 & predicted == 0)\n#   )\n# \n# cm %>% print\n# \n# TP <- cm$TP\n# TN <- cm$TN\n# FP <- cm$FP\n# FN <- cm$FN\n# \n# \n# accuracy <- (TP + TN) / (TP+TN+FP+FN)\n# print(paste0(\"Accuracy = \", round(accuracy,4)))\n# \n# sensitivity <- TP / (TP + FN)\n# print(paste0(\"Sensitivity / Recall / TPR = \", round(sensitivity,4)))\n# \n# specificity <- TN / (TN + FP)\n# print(paste0(\"Specificity / TNR = \", round(specificity,4)))\n# \n# PPV <- TP / (TP+FP)\n# print(paste0(\"Positive Predictive Value = \", round(PPV,2)))\n# \n# NPV <- TN / (TN+FN)\n# print(paste0(\"Negative Predictive Value = \", round(NPV,2)))\n```\n:::\n\n\n\n\n\n\n\n\n## Automatic stepwise\n\n_This_ particular stepwise regression leads to a much more complex model. It is important to note that the particular order of the predictors can change the final estimated \"best\" model (based on AIC).\n\nHowever what is very important is that the `cigs_per_day` is identified as an important predictor, despite our EDA repeatedly disconfirmed so. The reasons are therefore to be explored, however for the time being we will try to include it into our manually built model (see above.)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\n\nfullModel = glm(\n   ten_year_chd ~ male + prevalent_hyp + bp_meds + age + sys_bp + glucose + tot_chol,\n   family = \"binomial\", data = train\n)\n\nfullModel = glm(ten_year_chd ~ ., family = \"binomial\", data = train)\n\nnullModel = glm(ten_year_chd ~ 1, family = \"binomial\", data = train)\n\nstep_fit <- stepAIC(\n   fullModel, direction = 'backward', \n   scope = list(upper = fullModel, lower = nullModel), trace = 0\n)\n\nstep_fit %>% summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = ten_year_chd ~ male + age + education + cigs_per_day + \n    prevalent_stroke + prevalent_hyp + sys_bp + glucose, family = \"binomial\", \n    data = train)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-2.0023  -0.5868  -0.4197  -0.2915   2.7940  \n\nCoefficients:\n                   Estimate Std. Error z value Pr(>|z|)    \n(Intercept)       -7.655170   0.587371 -13.033  < 2e-16 ***\nmale1              0.387895   0.129655   2.992 0.002774 ** \nage                0.060750   0.007983   7.610 2.74e-14 ***\neducation2        -0.335970   0.150240  -2.236 0.025337 *  \neducation3        -0.352595   0.184679  -1.909 0.056232 .  \neducation4        -0.038528   0.195294  -0.197 0.843606    \ncigs_per_day       0.019113   0.005227   3.657 0.000256 ***\nprevalent_stroke1  0.969730   0.601408   1.612 0.106868    \nprevalent_hyp1     0.372800   0.161896   2.303 0.021295 *  \nsys_bp             0.013282   0.003412   3.893 9.92e-05 ***\nglucose            0.007787   0.002106   3.698 0.000217 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 2114.4  on 2470  degrees of freedom\nResidual deviance: 1860.2  on 2460  degrees of freedom\nAIC: 1882.2\n\nNumber of Fisher Scoring iterations: 5\n```\n:::\n\n```{.r .cell-code}\nstep_fit %>% jtools::summ(confint = T, vifs = T, digits = 2) %>% print()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nMODEL INFO:\nObservations: 2471\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(10) = 254.11, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.17\nPseudo-R² (McFadden) = 0.12\nAIC = 1882.24, BIC = 1946.18 \n\nStandard errors: MLE\n----------------------------------------------------------------------\n                           Est.    2.5%   97.5%   z val.      p    VIF\n----------------------- ------- ------- ------- -------- ------ ------\n(Intercept)               -7.66   -8.81   -6.50   -13.03   0.00       \nmale1                      0.39    0.13    0.64     2.99   0.00   1.19\nage                        0.06    0.05    0.08     7.61   0.00   1.23\neducation2                -0.34   -0.63   -0.04    -2.24   0.03   1.09\neducation3                -0.35   -0.71    0.01    -1.91   0.06   1.09\neducation4                -0.04   -0.42    0.34    -0.20   0.84   1.09\ncigs_per_day               0.02    0.01    0.03     3.66   0.00   1.22\nprevalent_stroke1          0.97   -0.21    2.15     1.61   0.11   1.01\nprevalent_hyp1             0.37    0.06    0.69     2.30   0.02   1.85\nsys_bp                     0.01    0.01    0.02     3.89   0.00   1.97\nglucose                    0.01    0.00    0.01     3.70   0.00   1.02\n----------------------------------------------------------------------\n```\n:::\n\n```{.r .cell-code}\n# Estimated probability values from the logistic model\nphat_step_fit = predict(step_fit, newdata = test, type = \"response\")\n```\n:::\n\n\n\n\n\n\nEvaluate predictivity of the stepwise model\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Binary prediction from the estimated probability values \nthresh <- 0.1\npredicted <- ifelse(phat_step_fit > thresh, 1, 0)\n\nactual_predicted <- tibble(\n   actual = test$ten_year_chd, \n   predicted = ifelse(phat_step_fit > thresh, 1, 0) \n)\n\ncaret::confusionMatrix(\n   as.factor(predicted), # predicted\n   as.factor(test$ten_year_chd), # actual \n   positive = \"1\"  # the positive class in our case is \"1\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nConfusion Matrix and Statistics\n\n          Reference\nPrediction   0   1\n         0 608  38\n         1 737 197\n                                          \n               Accuracy : 0.5095          \n                 95% CI : (0.4845, 0.5344)\n    No Information Rate : 0.8513          \n    P-Value [Acc > NIR] : 1               \n                                          \n                  Kappa : 0.1304          \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.8383          \n            Specificity : 0.4520          \n         Pos Pred Value : 0.2109          \n         Neg Pred Value : 0.9412          \n             Prevalence : 0.1487          \n         Detection Rate : 0.1247          \n   Detection Prevalence : 0.5911          \n      Balanced Accuracy : 0.6452          \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(test, phat_step_fit)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-06a5b60099d37fd1c213\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-06a5b60099d37fd1c213\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.706\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.452044609665428,\"sensitivity\":0.838297872340426,\"x\":0.452044609665428,\"y\":0.838297872340426},{\"threshold\":0.2,\"specificity\":0.76728624535316,\"sensitivity\":0.527659574468085,\"x\":0.76728624535316,\"y\":0.527659574468085},{\"threshold\":0.3,\"specificity\":0.901115241635688,\"sensitivity\":0.31063829787234,\"x\":0.901115241635688,\"y\":0.31063829787234},{\"threshold\":0.4,\"specificity\":0.965799256505576,\"sensitivity\":0.148936170212766,\"x\":0.965799256505576,\"y\":0.148936170212766},{\"threshold\":0.5,\"specificity\":0.991078066914498,\"sensitivity\":0.0936170212765957,\"x\":0.991078066914498,\"y\":0.0936170212765957},{\"threshold\":0.6,\"specificity\":0.997769516728625,\"sensitivity\":0.0425531914893617,\"x\":0.997769516728625,\"y\":0.0425531914893617},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0212765957446809,\"x\":1,\"y\":0.0212765957446809},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.452044609665428,\"sensitivity\":0.838297872340426,\"x\":0.452044609665428,\"y\":0.838297872340426},{\"threshold\":0.2,\"specificity\":0.76728624535316,\"sensitivity\":0.527659574468085,\"x\":0.76728624535316,\"y\":0.527659574468085},{\"threshold\":0.3,\"specificity\":0.901115241635688,\"sensitivity\":0.31063829787234,\"x\":0.901115241635688,\"y\":0.31063829787234},{\"threshold\":0.4,\"specificity\":0.965799256505576,\"sensitivity\":0.148936170212766,\"x\":0.965799256505576,\"y\":0.148936170212766},{\"threshold\":0.5,\"specificity\":0.991078066914498,\"sensitivity\":0.0936170212765957,\"x\":0.991078066914498,\"y\":0.0936170212765957},{\"threshold\":0.6,\"specificity\":0.997769516728625,\"sensitivity\":0.0425531914893617,\"x\":0.997769516728625,\"y\":0.0425531914893617},{\"threshold\":0.7,\"specificity\":1,\"sensitivity\":0.0212765957446809,\"x\":1,\"y\":0.0212765957446809},{\"threshold\":0.8,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.00851063829787234,\"x\":1,\"y\":0.00851063829787234},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n\n\n\n## Samples balanced for CHD risk\nOur sample is very unbalanced. We will select an equal number of people with and without risk in both train and test set to assess whether this will help model performance.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(9999)\n\nmin_train <- min(\n   nrow(train[train$ten_year_chd == 1,]),\n   nrow(train[train$ten_year_chd == 0,])   \n)\n\nbalanced_train <- train %>% \n   group_by(ten_year_chd) %>% \n   slice_sample(n = min_train)\n\n\nmin_test <- min(\n   nrow(test[test$ten_year_chd == 1,]),\n   nrow(test[test$ten_year_chd == 0,])   \n)\n\nbalanced_test <- test %>% \n   group_by(ten_year_chd) %>% \n   slice_sample(n = min_test)\n\n\n# Full model with the selected variables\nEVs  <- c(\n   \"male\", \"prevalent_hyp\", \"bp_meds\", \"education\",\n   \"age\", \"sys_bp\", \"bmi\", \"glucose\", \"tot_chol\"\n)\n\n\n# Remove education, bp_meds, bmi, tot_chol since they have\n# no effect on the model\nEVs  <- c(\n   \"male\", \"prevalent_hyp\",\n   \"age\", \"sys_bp\", \"glucose\"\n)\n\n\n# Remove prevalent_hyp since it is only marginally significant\nEVs  <- c(\n   \"male\", \"age\", \"sys_bp\", \"glucose\"\n)\n\n\n# The stepwise regression - below - identified cigs_per_day as an important factor.\n# I will therefore add it to the model.\nEVs  <- c(\n   \"male\", \"age\", \"sys_bp\", \"glucose\", \"cigs_per_day\"\n)\n\n\nphat <- do_logistic_regression(\n   EVs, \n   train_data = balanced_train, test_data = balanced_test,\n   thresh = 0.4\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = formula_obj, family = \"binomial\", data = train_data)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-2.1032  -1.0034  -0.1717   1.0161   2.0910  \n\nCoefficients:\n              Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -7.238967   0.720868 -10.042  < 2e-16 ***\nmale1         0.319629   0.169510   1.886  0.05935 .  \nage           0.074519   0.010682   6.976 3.04e-12 ***\nsys_bp        0.015708   0.003688   4.259 2.06e-05 ***\nglucose       0.010113   0.003923   2.578  0.00994 ** \ncigs_per_day  0.030757   0.007706   3.991 6.57e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 1048.04  on 755  degrees of freedom\nResidual deviance:  910.19  on 750  degrees of freedom\nAIC: 922.19\n\nNumber of Fisher Scoring iterations: 4\n\nMODEL INFO:\nObservations: 756\nDependent Variable: ten_year_chd\nType: Generalized linear model\n  Family: binomial \n  Link function: logit \n\nMODEL FIT:\nχ²(5) = 137.85, p = 0.00\nPseudo-R² (Cragg-Uhler) = 0.22\nPseudo-R² (McFadden) = 0.13\nAIC = 922.19, BIC = 949.96 \n\nStandard errors: MLE\n--------------------------------------------------------------------\n                     exp(Est.)   2.5%   97.5%   z val.      p    VIF\n------------------ ----------- ------ ------- -------- ------ ------\n(Intercept)               0.00   0.00    0.00   -10.04   0.00       \nmale1                     1.38   0.99    1.92     1.89   0.06   1.12\nage                       1.08   1.06    1.10     6.98   0.00   1.18\nsys_bp                    1.02   1.01    1.02     4.26   0.00   1.11\nglucose                   1.01   1.00    1.02     2.58   0.01   1.01\ncigs_per_day              1.03   1.02    1.05     3.99   0.00   1.20\n--------------------------------------------------------------------\n\n Using a threshold for prediction = 0.40 \n\nConfusion Matrix and Statistics\n\n          Reference\nPrediction   0   1\n         0 115  44\n         1 120 191\n                                          \n               Accuracy : 0.6511          \n                 95% CI : (0.6061, 0.6941)\n    No Information Rate : 0.5             \n    P-Value [Acc > NIR] : 2.818e-11       \n                                          \n                  Kappa : 0.3021          \n                                          \n Mcnemar's Test P-Value : 4.727e-09       \n                                          \n            Sensitivity : 0.8128          \n            Specificity : 0.4894          \n         Pos Pred Value : 0.6141          \n         Neg Pred Value : 0.7233          \n             Prevalence : 0.5000          \n         Detection Rate : 0.4064          \n   Detection Prevalence : 0.6617          \n      Balanced Accuracy : 0.6511          \n                                          \n       'Positive' Class : 1               \n                                          \n```\n:::\n\n```{.r .cell-code}\nplot_ROC(balanced_test, phat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting levels: control = 0, case = 1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nSetting direction: controls < cases\n```\n:::\n\n::: {.cell-output-display}\n```{=html}\n<div class=\"highchart html-widget html-fill-item-overflow-hidden html-fill-item\" id=\"htmlwidget-b89bf2f95fec116677a3\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-b89bf2f95fec116677a3\">{\"x\":{\"hc_opts\":{\"chart\":{\"reflow\":true,\"aspectRatio\":1},\"title\":{\"text\":\"ROC curve - AUC = 0.738\"},\"yAxis\":{\"title\":{\"text\":\"Sensitivity\"},\"type\":\"linear\",\"min\":0,\"max\":1},\"credits\":{\"enabled\":false},\"exporting\":{\"enabled\":false},\"boost\":{\"enabled\":false},\"plotOptions\":{\"series\":{\"label\":{\"enabled\":false},\"turboThreshold\":0,\"showInLegend\":false},\"treemap\":{\"layoutAlgorithm\":\"squarified\"},\"scatter\":{\"marker\":{\"symbol\":\"circle\"}}},\"series\":[{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.00425531914893617,\"sensitivity\":0.995744680851064,\"x\":0.00425531914893617,\"y\":0.995744680851064},{\"threshold\":0.2,\"specificity\":0.14468085106383,\"sensitivity\":0.978723404255319,\"x\":0.14468085106383,\"y\":0.978723404255319},{\"threshold\":0.3,\"specificity\":0.319148936170213,\"sensitivity\":0.914893617021277,\"x\":0.319148936170213,\"y\":0.914893617021277},{\"threshold\":0.4,\"specificity\":0.48936170212766,\"sensitivity\":0.812765957446808,\"x\":0.48936170212766,\"y\":0.812765957446808},{\"threshold\":0.5,\"specificity\":0.651063829787234,\"sensitivity\":0.668085106382979,\"x\":0.651063829787234,\"y\":0.668085106382979},{\"threshold\":0.6,\"specificity\":0.825531914893617,\"sensitivity\":0.493617021276596,\"x\":0.825531914893617,\"y\":0.493617021276596},{\"threshold\":0.7,\"specificity\":0.927659574468085,\"sensitivity\":0.31063829787234,\"x\":0.927659574468085,\"y\":0.31063829787234},{\"threshold\":0.8,\"specificity\":0.978723404255319,\"sensitivity\":0.148936170212766,\"x\":0.978723404255319,\"y\":0.148936170212766},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.0297872340425532,\"x\":1,\"y\":0.0297872340425532},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"line\"},{\"group\":\"group\",\"data\":[{\"threshold\":0,\"specificity\":0,\"sensitivity\":1,\"x\":0,\"y\":1},{\"threshold\":0.1,\"specificity\":0.00425531914893617,\"sensitivity\":0.995744680851064,\"x\":0.00425531914893617,\"y\":0.995744680851064},{\"threshold\":0.2,\"specificity\":0.14468085106383,\"sensitivity\":0.978723404255319,\"x\":0.14468085106383,\"y\":0.978723404255319},{\"threshold\":0.3,\"specificity\":0.319148936170213,\"sensitivity\":0.914893617021277,\"x\":0.319148936170213,\"y\":0.914893617021277},{\"threshold\":0.4,\"specificity\":0.48936170212766,\"sensitivity\":0.812765957446808,\"x\":0.48936170212766,\"y\":0.812765957446808},{\"threshold\":0.5,\"specificity\":0.651063829787234,\"sensitivity\":0.668085106382979,\"x\":0.651063829787234,\"y\":0.668085106382979},{\"threshold\":0.6,\"specificity\":0.825531914893617,\"sensitivity\":0.493617021276596,\"x\":0.825531914893617,\"y\":0.493617021276596},{\"threshold\":0.7,\"specificity\":0.927659574468085,\"sensitivity\":0.31063829787234,\"x\":0.927659574468085,\"y\":0.31063829787234},{\"threshold\":0.8,\"specificity\":0.978723404255319,\"sensitivity\":0.148936170212766,\"x\":0.978723404255319,\"y\":0.148936170212766},{\"threshold\":0.9,\"specificity\":1,\"sensitivity\":0.0297872340425532,\"x\":1,\"y\":0.0297872340425532},{\"threshold\":1,\"specificity\":1,\"sensitivity\":0,\"x\":1,\"y\":0}],\"type\":\"scatter\",\"marker\":{\"radius\":6,\"fillColor\":\"lightblue\",\"lineWidth\":2},\"tooltip\":{\"headerFormat\":\"\",\"pointFormat\":\"<b>Threshold: {point.threshold:.2f}<\\/b><br>\\n                           Sensitivity: {point.y:.2f}<br>\\n                           Specificity: {point.x:.2f}\"}}],\"xAxis\":{\"type\":\"linear\",\"title\":{\"text\":\"Specificity\"},\"reversed\":true,\"min\":0,\"max\":1}},\"theme\":{\"chart\":{\"backgroundColor\":\"transparent\"},\"colors\":[\"#7cb5ec\",\"#434348\",\"#90ed7d\",\"#f7a35c\",\"#8085e9\",\"#f15c80\",\"#e4d354\",\"#2b908f\",\"#f45b5b\",\"#91e8e1\"]},\"conf_opts\":{\"global\":{\"Date\":null,\"VMLRadialGradientURL\":\"http =//code.highcharts.com/list(version)/gfx/vml-radial-gradient.png\",\"canvasToolsURL\":\"http =//code.highcharts.com/list(version)/modules/canvas-tools.js\",\"getTimezoneOffset\":null,\"timezoneOffset\":0,\"useUTC\":true},\"lang\":{\"contextButtonTitle\":\"Chart context menu\",\"decimalPoint\":\".\",\"downloadCSV\":\"Download CSV\",\"downloadJPEG\":\"Download JPEG image\",\"downloadPDF\":\"Download PDF document\",\"downloadPNG\":\"Download PNG image\",\"downloadSVG\":\"Download SVG vector image\",\"downloadXLS\":\"Download XLS\",\"drillUpText\":\"◁ Back to {series.name}\",\"exitFullscreen\":\"Exit from full screen\",\"exportData\":{\"annotationHeader\":\"Annotations\",\"categoryDatetimeHeader\":\"DateTime\",\"categoryHeader\":\"Category\"},\"hideData\":\"Hide data table\",\"invalidDate\":null,\"loading\":\"Loading...\",\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"noData\":\"No data to display\",\"numericSymbolMagnitude\":1000,\"numericSymbols\":[\"k\",\"M\",\"G\",\"T\",\"P\",\"E\"],\"printChart\":\"Print chart\",\"resetZoom\":\"Reset zoom\",\"resetZoomTitle\":\"Reset zoom level 1:1\",\"shortMonths\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"shortWeekdays\":[\"Sat\",\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\"],\"thousandsSep\":\" \",\"viewData\":\"View data table\",\"viewFullscreen\":\"View in full screen\",\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]}},\"type\":\"chart\",\"fonts\":[],\"debug\":false},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\n# CHD Prediction app\n\n\n\n\n\nUse the following model - estimated on the whole dataset - to predict the 10-year risk of CHD according to the given input.\n\n$$\nlogOdds_{10yr-CHD-risk} = -8.671 + 0.51*male + 0.061*age + 0.0173*sys\\_bp + 0.00758*glucose + 0.0204 * cigs\\_per\\_day\n$$\n\n$$\np = \\frac{e^{logOdds}}{1 + e^{logOdds}}\n$$\n\n\n**NB: only for illustrational purposes. Read and accept the following Disclaimer first**\n\n\n::: {.cell}\n<iframe src=\"https://agronomous.shinyapps.io/chd_risk_app/?showcase=0\" width=\"672\" height=\"1100\" data-external=\"1\"></iframe>\n:::\n\n\n\n\n",
    "supporting": [
      "Graded_Task_Logistic_Regression_V5_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/tabwid-1.1.2/tabwid.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.0/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/jquery-3.5.1/jquery.min.js\"></script>\n<script src=\"../../site_libs/proj4js-2.3.15/proj4.js\"></script>\n<link href=\"../../site_libs/highcharts-9.3.1/css/motion.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/highcharts-9.3.1/highcharts.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/highcharts-3d.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/highcharts-more.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/stock.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/map.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/data.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/exporting.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/offline-exporting.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/drilldown.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/item-series.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/overlapping-datalabels.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/annotations.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/export-data.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/funnel.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/heatmap.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/treemap.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/sankey.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/dependency-wheel.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/organization.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/solid-gauge.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/streamgraph.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/sunburst.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/vector.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/wordcloud.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/xrange.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/tilemap.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/venn.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/gantt.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/timeline.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/parallel-coordinates.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/bullet.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/coloraxis.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/dumbbell.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/lollipop.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/series-label.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/plugins/motion.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/custom/reset.js\"></script>\n<script src=\"../../site_libs/highcharts-9.3.1/modules/boost.js\"></script>\n<script src=\"../../site_libs/highchart-binding-0.9.4/highchart.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}